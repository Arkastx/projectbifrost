<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Bifrost - Uma Stats</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=IBM+Plex+Sans:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --font-family: 'Inter', 'IBM Plex Sans', system-ui, -apple-system, 'Segoe UI', sans-serif;
            --bg: #0f1220;
            --surface: #151a2b;
            --surface-2: #111626;
            --surface-3: #0b1020;
            --border: rgba(148, 163, 184, 0.18);
            --text: #e5e7eb;
            --muted: #94a3b8;
            --muted-2: #64748b;
            --accent: #6aa9ff;
            --accent-soft: rgba(106, 169, 255, 0.18);
            --warning: #f59e0b;
            --danger: #ef4444;
            --success: #22c55e;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-family);
            font-variant-numeric: tabular-nums;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 16px;
        }
        .container {
            width: 58vw;
            max-width: 1280px;
            min-width: 820px;
            margin: 0 auto;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }
        .header-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        .header-toggle {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.78rem;
            color: var(--muted);
        }
        .header-toggle input {
            accent-color: var(--accent);
        }
        h1 { font-size: 1.4rem; color: #8ab4ff; font-weight: 600; }
        .status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--muted);
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #64748b;
        }
        .status-dot.connected { background: #4ade80; }
        .status-dot.training { background: #fbbf24; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 6px;
            flex-wrap: wrap;
        }
        .tab {
            padding: 8px 14px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 8px;
            color: var(--muted);
            cursor: pointer;
            font-size: 0.82rem;
            transition: background 0.2s, color 0.2s, border-color 0.2s;
        }
        .tab:hover { color: var(--text); border-color: var(--border); }
        .tab.active {
            background: var(--accent-soft);
            color: #dbeafe;
            border-color: rgba(106, 169, 255, 0.4);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }
        .card h2 {
            font-size: 0.9rem;
            color: var(--muted);
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Training header */
        .training-topbar {
            display: grid;
            grid-template-columns: auto auto auto;
            gap: 18px;
            padding: 12px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 12px;
            align-items: center;
        }
        #tab-training.active {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        #tab-training.active .training-topbar,
        #tab-training.active .phase-strip,
        #tab-training.active > .card {
            width: 760px;
            max-width: 100%;
        }
        .training-topbar-left,
        .training-topbar-right,
        .training-topbar-center {
            display: flex;
            align-items: center;
            gap: 18px;
        }
        .training-topbar-center {
            justify-content: center;
        }
        .training-topbar-right {
            justify-content: flex-start;
        }
        .training-topbar-left {
            justify-content: flex-start;
        }
        .training-slot {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
        }
        .training-slot-label {
            font-size: 0.62rem;
            color: var(--muted-2);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        .training-slot-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
        }
        .training-slot-sub {
            font-size: 0.75rem;
            color: var(--muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .training-slot-sub.scenario {
            color: #d6e1ff;
        }
        .training-slot.energy {
            align-items: center;
            text-align: center;
            min-width: 0;
        }
        .training-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 8px;
            background: rgba(148, 163, 184, 0.12);
            color: var(--text);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .training-pill.suggested {
            box-shadow: inset 0 0 0 1px rgba(106, 169, 255, 0.6);
            background: rgba(15, 23, 42, 0.35);
        }
        .training-pill.rest {
            background: rgba(148, 163, 184, 0.16);
        }
        .training-pill.training-status {
            text-transform: none;
            font-weight: 500;
            letter-spacing: 0;
            padding: 8px 14px;
            gap: 12px;
            min-width: 150px;
            justify-content: space-between;
        }
        .training-pill-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .training-pill-title {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--muted);
        }
        .training-pill-next {
            font-size: 0.8rem;
            color: var(--text);
        }
        .training-pill-icon {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            object-fit: cover;
            background: var(--surface-3);
            border: 1px solid rgba(148, 163, 184, 0.2);
        }
        .energy-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .energy-bar {
            flex: 1;
            height: 6px;
            background: rgba(148, 163, 184, 0.2);
            border-radius: 999px;
            overflow: hidden;
        }
        .energy-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.2s ease;
        }
        .connection-pill {
            display: none;
        }

        /* Motivation bubble */
        .motivation-bubble {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0 12px;
            height: 24px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
            color: #fff;
            text-transform: uppercase;
            white-space: nowrap;
        }
        .motivation-bubble.awful { background: #9333ea; }
        .motivation-bubble.bad { background: #3b82f6; }
        .motivation-bubble.normal { background: #eab308; }
        .motivation-bubble.good { background: #f97316; }
        .motivation-bubble.great { background: #ec4899; }

        .energy-cap {
            font-weight: 700;
        }

        /* Training cards grid */
        .training-strip {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0;
            border-radius: 8px;
            overflow: visible;
            background: var(--surface-2);
            border: 1px solid var(--border);
        }
        .training-card {
            background: transparent;
            padding: 10px 12px 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            border-right: 1px solid var(--border);
            min-height: 220px;
            text-align: center;
            position: relative;
        }
        .training-card:last-child {
            border-right: none;
        }
        .training-card.suggested {
            outline: 2px solid rgba(34, 197, 94, 0.95);
            outline-offset: -1px;
            box-shadow: 0 0 18px rgba(34, 197, 94, 0.45);
            background: rgba(15, 23, 42, 0.35);
            z-index: 2;
            border-radius: 0;
        }
        .training-card.stat-speed { border-top: 1px solid rgba(96, 165, 250, 0.6); }
        .training-card.stat-stamina { border-top: 1px solid rgba(251, 146, 60, 0.6); }
        .training-card.stat-power { border-top: 1px solid rgba(248, 113, 113, 0.6); }
        .training-card.stat-guts { border-top: 1px solid rgba(244, 114, 182, 0.6); }
        .training-card.stat-wit { border-top: 1px solid rgba(52, 211, 153, 0.6); }

        /* Training minimal view: hide auxiliary rows */
        .training-card-top,
        .training-badges,
        .training-breakdown,
        .training-costs,
        .training-supporters {
            display: none !important;
        }

        .training-card-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        .training-level {
            color: var(--muted);
            font-weight: 600;
            font-size: 0.7rem;
        }
        .training-fail {
            font-weight: 600;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.6);
        }
        .fail-0 { color: #22c55e; }
        .fail-low { color: #3b82f6; }
        .fail-mid { color: #eab308; }
        .fail-high { color: #f97316; }
        .fail-danger { color: #ef4444; }

        /* ===== TRAINING CARD STAT LAYOUT =====
         * Structure:
         *   .training-label: [icon] [STAT NAME] - centered
         *   .training-value: [rank-icon] [number] [+gain / /max] - centered as group
         */
        .training-label {
            font-size: 0.72rem;
            text-transform: uppercase;
            font-weight: 600;
            color: var(--text);
            letter-spacing: 0.08em;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            width: 100%;
        }
        .training-label .stat-label-icon {
            width: 16px;
            height: 16px;
            object-fit: contain;
            position: absolute;
            right: calc(50% + 2.5em);
        }
        .training-label.rainbow,
        .training-label.rainbow span {
            background: linear-gradient(90deg, #ef4444, #f97316, #eab308, #22c55e, #3b82f6, #9333ea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }
        .stat-label-icon.rainbow {
            filter: hue-rotate(45deg) saturate(2);
        }
        .training-rb {
            position: absolute;
            top: 8px;
            right: 10px;
            font-size: 0.62rem;
            font-weight: 600;
            color: var(--muted);
            letter-spacing: 0.04em;
        }
        .training-rb.rainbow {
            background: linear-gradient(90deg, #ef4444, #f97316, #eab308, #22c55e, #3b82f6, #9333ea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }
        .training-rb.zeroed {
            opacity: 0;
        }
        .training-label.rainbow {
            color: #fbbf24;
        }

        .training-value {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            width: 100%;
        }
        .training-gains {
            font-size: 0.62rem;
            font-weight: 600;
            color: #16a34a;
            text-align: center;
            letter-spacing: 0.02em;
            margin-top: 4px;
            white-space: nowrap;
            width: 100%;
        }
        .training-metrics {
            font-size: 0.70rem;
            font-weight: 600;
            color: var(--muted);
            text-align: center;
            letter-spacing: 0.03em;
            margin-top: 3px;
            white-space: nowrap;
            width: 100%;
        }
        .training-metrics .energy-pos { color: #22c55e; }
        .training-metrics .energy-neg { color: #ef4444; }
        .training-metrics .energy-neg .energy-value { color: #fca5a5; }
        .training-metrics .fail-0 { color: #86efac; }
        .training-metrics .fail-low { color: #3b82f6; }
        .training-metrics .fail-mid { color: #eab308; }
        .training-metrics .fail-high { color: #f97316; }
        .training-metrics .fail-danger { color: #ef4444; }
        .training-hint-count {
            font-size: 0.62rem;
            font-weight: 600;
            color: var(--muted);
            text-align: center;
            letter-spacing: 0.02em;
            margin-top: 2px;
            white-space: nowrap;
            width: 100%;
        }
        .training-hint-count .hint-text { color: #7dd3fc; }
        .training-hint-count .bond-text { color: #f9a8d4; }
        .training-hint-count .zeroed { opacity: 0; }
        .training-unity-count {
            font-size: 0.6rem;
            font-weight: 600;
            color: #86efac;
            text-align: center;
            letter-spacing: 0.02em;
            margin-top: 2px;
            white-space: nowrap;
            width: 100%;
        }
        .training-unity-count .spirit-text {
            color: #1d4ed8;
        }
        .training-unity-count .zeroed { opacity: 0; }
        .training-supporter-line {
            display: flex;
            justify-content: center;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 2px;
            width: 100%;
        }
        .training-supporter-line .supporter-chip {
            padding: 2px 6px;
            background: rgba(148, 163, 184, 0.12);
        }
        .training-supporter-line .supporter-chip img {
            width: 22px;
            height: 22px;
        }
        .training-gains .gain-value {
            color: #4ade80;
        }
        .training-gains .gain-label {
            color: #16a34a;
        }
        .stat-rank-icon {
            width: 30px;
            height: 30px;
            object-fit: contain;
            position: absolute;
            right: calc(50% + 1.1em);
        }
        .stat-number-group {
            display: inline-flex;
            align-items: center;
            position: relative;
        }
        .stat-main {
            font-weight: 700;
        }
        .stat-sup {
            font-size: 0.7rem;
            color: #4ade80;
            position: absolute;
            left: 100%;
            top: -0.5em;
            margin-left: 2px;
            font-weight: 700;
            white-space: nowrap;
        }
        .stat-sub {
            font-size: 0.65rem;
            color: var(--muted-2);
            position: absolute;
            left: 100%;
            bottom: -0.3em;
            margin-left: 2px;
            white-space: nowrap;
        }

        .training-badges {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-left: auto;
        }
        .badge {
            font-size: 0.62rem;
            font-weight: 600;
            padding: 0;
            border-radius: 0;
            background: transparent;
            color: var(--muted);
        }
        .badge-hint { color: #7dd3fc; }
        .badge-rainbow { color: #fbbf24; }
        .badge-risk { color: #f97316; }
        .badge-highbond { color: #34d399; }
        .badge.hidden { display: none; }

        .training-breakdown {
            display: flex;
            flex-direction: row;
            justify-content: center;
            gap: 6px;
            font-size: 0.6rem;
            color: var(--muted);
            text-align: center;
            flex-wrap: wrap;
        }
        .training-breakdown .breakdown-stat {
            white-space: nowrap;
        }
        .breakdown-title {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--muted);
        }
        .breakdown-line {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            color: var(--text);
        }

        .training-costs {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 6px;
            font-size: 0.7rem;
            color: var(--muted);
        }
        .cost-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 0;
            border-radius: 0;
            background: transparent;
        }
        .cost-icon {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }
        .cost-value {
            font-weight: 600;
            color: var(--text);
        }
        .cost-value.low { color: #86efac; }
        .cost-value.mid { color: #fde047; }
        .cost-value.high { color: #f87171; }

        .training-details {
            display: none;
        }

        .training-details {
            margin-bottom: 12px;
            border-radius: 12px;
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 12px;
        }
        .training-details summary {
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            list-style: none;
        }
        .training-details summary::-webkit-details-marker { display: none; }
        .training-details[open] summary {
            margin-bottom: 12px;
            color: #dbeafe;
        }

        /* Reasons panel */
        .reasons-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 8px;
        }
        .reasons-card {
            background: #0f172a;
            border-radius: 6px;
            padding: 8px;
            font-size: 0.65rem;
        }
        .reason-row {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
            color: #888;
        }
        .reason-value { color: #4ade80; }
        .reason-value.negative { color: #ef4444; }
        .reason-pal { color: #ec4899; }

        .training-supporters {
            display: flex;
            gap: 6px;
            margin-top: 6px;
            flex-wrap: wrap;
        }
        .supporter-chip {
            position: relative;
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(148, 163, 184, 0.12);
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 0.7rem;
            color: var(--text);
        }
        .supporter-chip img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }
        .hint-badge {
            position: absolute;
            right: -2px;
            top: -2px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #f87171;
            color: #fff;
            font-size: 11px;
            font-weight: 700;
            line-height: 16px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,.3);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }
        .info-row:last-child { border-bottom: none; }
        .info-label { color: #888; }

        /* Skills list */
        .skills-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .skill-tag {
            padding: 4px 10px;
            background: #1a1a2e;
            border-radius: 4px;
            font-size: 0.8rem;
            color: #a855f7;
        }
        .skills-empty {
            color: #666;
            font-style: italic;
        }
        .skills-header {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
        }
        #tab-stats.active {
            display: flex;
            justify-content: flex-start;
        }
        #tab-stats.active .card {
            width: 560px;
            max-width: 100%;
            margin: 0;
        }
        .skills-portrait {
            width: 64px;
            height: 64px;
            border-radius: 8px;
            object-fit: cover;
            background: #0f172a;
        }
        .skills-name {
            font-size: 1rem;
            font-weight: 700;
        }
        .skills-sub {
            font-size: 0.8rem;
            color: #9ca3af;
        }
        .skills-stat-strip {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            background: var(--surface-2);
            max-width: 100%;
            margin-left: 0;
        }
        .skills-stat {
            background: transparent;
            text-align: center;
            font-weight: 700;
            color: #fff;
            border-right: 1px solid var(--border);
        }
        .skills-stat:last-child {
            border-right: none;
        }
        .skills-stat-header {
            background: transparent;
            color: var(--muted);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 6px 8px;
            font-size: 0.72rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        .skills-stat-body {
            display: grid;
            grid-template-columns: auto 1fr;
            align-items: center;
            gap: 6px;
            padding: 8px;
        }
        .stat-icon {
            width: 18px;
            height: 18px;
            object-fit: contain;
            filter: drop-shadow(0 1px 0 rgba(0,0,0,0.25));
        }
        .skills-rank-icon {
            width: 28px;
            height: 20px;
            object-fit: contain;
        }
        .skills-stat-value {
            font-size: 1rem;
            color: #fff;
        }
        .skills-stat-max {
            font-size: 0.75rem;
            color: var(--muted);
        }
        .skills-stat span {
            display: block;
            font-size: 0.7rem;
            color: #9ca3af;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .aptitude-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-bottom: 12px;
            max-width: 100%;
        }
        .aptitude-group {
            background: #1a1a2e;
            border-radius: 6px;
            padding: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .aptitude-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: #9ca3af;
            min-width: 70px;
        }
        .aptitude-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            font-size: 0.85rem;
        }
        .apt-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            min-width: 70px;
            justify-content: flex-start;
            font-weight: 700;
            color: #fff;
            background: #0f172a;
            border-radius: 6px;
            padding: 4px 6px;
        }
        .apt-icon {
            width: 24px;
            height: 14px;
            object-fit: contain;
        }
        .skill-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #0f172a;
            border-radius: 6px;
            padding: 6px 8px;
            margin-bottom: 6px;
        }
        .skill-icon {
            width: 28px;
            height: 28px;
            object-fit: contain;
            border-radius: 4px;
            background: #0b1220;
        }
        .skill-text {
            font-size: 0.8rem;
        }
        .skill-hint-icon {
            width: 18px;
            height: 18px;
            object-fit: contain;
            margin-left: auto;
        }
        .skills-raw {
            font-family: monospace;
            font-size: 0.7rem;
            background: #0a0a15;
            padding: 10px;
            border-radius: 6px;
            white-space: pre-wrap;
        }
        .skills-growth {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }
        #veteran-detail .skills-header {
            gap: 8px;
            margin-bottom: 8px;
        }
        #veteran-detail .skills-stat-strip {
            margin-bottom: 8px;
        }
        #veteran-detail .skills-stat-header {
            padding: 4px 6px;
            gap: 4px;
        }
        #veteran-detail .skills-stat-body {
            padding: 6px;
            gap: 4px;
        }
        #veteran-detail .aptitude-row {
            gap: 6px;
        }
        #veteran-detail .apt-badge {
            min-width: 60px;
            padding: 4px 6px;
        }
        #veteran-detail .skills-list {
            gap: 6px;
        }
        .growth-pill {
            background: #0f172a;
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 0.75rem;
            color: #e5e7eb;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .skills-section {
            margin-top: 12px;
        }
        .skills-section h3 {
            font-size: 0.75rem;
            color: var(--muted);
            text-transform: uppercase;
            margin-bottom: 6px;
            letter-spacing: 0.08em;
        }
        .skills-section summary {
            cursor: pointer;
            font-size: 0.75rem;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            list-style: none;
        }
        .skills-section summary::-webkit-details-marker { display: none; }
        .skills-section[open] summary {
            margin-bottom: 6px;
            color: #dbeafe;
        }
        .veteran-card {
            background: #1a1a2e;
            border-radius: 8px;
            padding: 10px;
            display: grid;
            grid-template-columns: 64px 1fr;
            gap: 10px;
            position: relative;
        }
        .veteran-card.selected-uma {
            box-shadow: 0 0 0 2px #22c55e;
        }
        .veteran-card.selected-uma-1 {
            box-shadow: 0 0 0 2px #22c55e;
        }
        .veteran-card.selected-uma-2 {
            box-shadow: 0 0 0 2px #10b981;
        }
        .veteran-compare-tag {
            position: absolute;
            left: 6px;
            top: 6px;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 999px;
            background: rgba(34, 197, 94, 0.2);
            color: #bbf7d0;
            border: 1px solid rgba(34, 197, 94, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }
        .veteran-compare-tag.uma2 {
            background: rgba(16, 185, 129, 0.2);
            color: #a7f3d0;
            border-color: rgba(16, 185, 129, 0.6);
        }
        .veteran-list-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
        }
        .favorite-star {
            position: absolute;
            top: 6px;
            right: 6px;
            background: transparent;
            border: none;
            color: #fbbf24;
            font-size: 1.1rem;
            cursor: pointer;
        }
        .misc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
        }
        .misc-section {
            background: #1a1a2e;
            border-radius: 8px;
            padding: 10px;
        }
        .misc-section h3 {
            font-size: 0.8rem;
            color: #9ca3af;
            text-transform: uppercase;
            margin-bottom: 8px;
        }
        .misc-item {
            display: flex;
            justify-content: space-between;
            gap: 8px;
            font-size: 0.8rem;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .misc-item:last-child {
            border-bottom: none;
        }
        .misc-key {
            color: #cbd5f5;
        }
        .misc-value {
            color: #f1f5f9;
            text-align: right;
            word-break: break-word;
        }
        .veteran-card .veteran-portrait {
            width: 64px;
            height: 64px;
            border-radius: 8px;
            object-fit: cover;
            background: #0f172a;
        }
        .rank-badge {
            width: 36px;
            height: 18px;
            vertical-align: middle;
            margin-right: 6px;
        }
        .umarank-icon {
            width: 48px;
            height: 20px;
            object-fit: contain;
            vertical-align: middle;
            margin-right: 6px;
        }
        .veteran-name {
            font-weight: 700;
            margin-bottom: 4px;
        }
        .veteran-meta {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-bottom: 6px;
        }
        .veteran-stats {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
            font-size: 0.75rem;
        }
        .veteran-stats div {
            background: #0f172a;
            border-radius: 4px;
            padding: 4px 6px;
            text-align: center;
            font-weight: 700;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .veteran-stat-label {
            font-size: 0.65rem;
            color: #9ca3af;
            letter-spacing: 0.02em;
        }
        .veteran-stat-value {
            font-size: 0.9rem;
            color: #e5e7eb;
        }
        .veteran-sparks {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 6px;
        }
        .spark-bubble {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 700;
            color: #fff;
        }
        .spark-blue { background: #2563eb; }
        .spark-orange { background: #f97316; }
        .spark-green { background: #16a34a; }
        .umalator-slots {
            display: grid;
            grid-template-columns: repeat(2, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }
        .umalator-slot {
            border: 2px dashed rgba(148, 163, 184, 0.3);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            color: #94a3b8;
            font-size: 0.75rem;
            background: rgba(15, 23, 42, 0.5);
        }
        .veteran-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .veteran-modal-content {
            background: #16213e;
            border-radius: 12px;
            padding: 16px;
            width: min(860px, 94vw);
            max-height: 90vh;
            overflow: auto;
        }
        .veteran-modal-close {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-top: 12px;
            background: #0b2f6b;
            color: #e5e7eb;
            border: 1px solid rgba(148, 163, 184, 0.3);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
        }
        .filters-button {
            background: #0b2f6b;
            color: #e5e7eb;
            border: 1px solid rgba(148, 163, 184, 0.3);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
        }
        .filters-summary {
            font-size: 0.7rem;
            color: #9ca3af;
        }
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .filters-row {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            color: #cbd5f5;
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 12px;
        }
        .modal-actions button {
            background: #0b2f6b;
            color: #e5e7eb;
            border: 1px solid rgba(148, 163, 184, 0.3);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
        }

        /* Supporter list */
        .supporter-list {
            display: grid;
            grid-template-columns: repeat(6, minmax(0, 1fr));
            gap: 12px;
        }
        .supporter-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            min-width: 0;
            position: relative;
        }
        .supporter-item img {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            object-fit: cover;
            background: transparent;
            border: none;
        }
        .supporter-hint-icon {
            position: absolute;
            top: -2px;
            right: 6px;
            width: 16px;
            height: 16px;
            object-fit: contain;
        }
        .supporter-name {
            font-size: 0.65rem;
            text-align: center;
            color: var(--muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 72px;
        }
        .supporter-bond {
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--text);
        }
        .supporter-bond-bar {
            width: 100%;
            height: 4px;
            background: rgba(148, 163, 184, 0.2);
            border-radius: 999px;
            overflow: hidden;
        }
        .supporter-bond-fill {
            height: 100%;
            background: #2ac0ff;
        }

        /* Settings */
        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }
        .settings-row:last-child { border-bottom: none; }
        .settings-subtitle {
            margin: 18px 0 10px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #9fb0c6;
        }
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }
        .settings-grid .settings-row {
            border-bottom: none;
            padding: 0;
        }
        .settings-label {
            color: var(--muted);
            font-size: 0.85rem;
        }
        .settings-select {
            background: var(--surface-2);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 0.8rem;
            cursor: pointer;
        }
        .settings-select:hover { border-color: rgba(106, 169, 255, 0.4); }

        /* Race + Event */
        .race-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .race-item {
            display: flex;
            justify-content: flex-start;
            background: var(--surface-2);
            border-radius: 10px;
            padding: 8px 10px;
            font-size: 0.8rem;
            gap: 12px;
            border: 1px solid var(--border);
        }
        .race-label {
            color: var(--text);
            min-width: 120px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .race-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .race-banner {
            width: 128px;
            height: 64px;
            object-fit: cover;
            border-radius: 8px;
            background: var(--surface-3);
            border: 1px solid rgba(148, 163, 184, 0.2);
        }
        .race-meta {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            font-size: 0.7rem;
            color: var(--muted);
            margin-top: 4px;
        }
        .race-pill {
            border-radius: 999px;
            padding: 2px 8px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .race-pill-icon {
            width: 18px;
            height: 18px;
            object-fit: contain;
            flex: 0 0 auto;
        }
        .race-pill-grade .race-pill-icon {
            width: 50px;
            height: 50px;
        }
        .race-requirement {
            color: #fbbf24;
            font-weight: 700;
            font-size: 0.75rem;
            margin-top: 4px;
        }
        .race-objective-tag {
            color: #fbbf24;
            font-weight: 700;
            font-size: 0.7rem;
            margin-top: 2px;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }
        .umalator-btn {
            margin-top: 6px;
            background: rgba(106, 169, 255, 0.18);
            color: #e5e7eb;
            border: 1px solid rgba(106, 169, 255, 0.4);
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
        }
        .umalator-btn:hover {
            background: rgba(106, 169, 255, 0.28);
        }
        .race-toggle {
            display: flex;
            gap: 12px;
            align-items: center;
            font-size: 0.8rem;
            color: var(--muted);
            margin-bottom: 10px;
        }
        .race-toggle input {
            margin-right: 6px;
        }
        .race-label { color: #cbd5f5; }
        .race-id { color: #9ca3af; }
        .event-choice {
            background: #1a1a2e;
            border-radius: 6px;
            padding: 8px 10px;
            margin-bottom: 8px;
        }
        .event-title {
            font-size: 0.8rem;
            font-weight: 700;
            color: #e5e7eb;
            margin-bottom: 4px;
        }
        .event-effect {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        /* Raw data */
        #raw-data {
            font-family: monospace;
            font-size: 0.7rem;
            background: #0a0a15;
            padding: 12px;
            border-radius: 4px;
            max-height: 400px;
            overflow: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Project Bifrost</h1>
            <div class="header-controls">
                <label class="header-toggle">
                    <input type="checkbox" id="always-on-top-toggle">
                    Always on top
                </label>
                <div class="status">
                    <span id="status-text">Disconnected</span>
                    <div class="status-dot" id="status-dot"></div>
                </div>
            </div>
        </header>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="training">Training</button>
            <button class="tab" data-tab="stats">Stats</button>
            <button class="tab" data-tab="race">Race</button>
            <button class="tab" data-tab="veteran-umalator">Veteran</button>
            <button class="tab" data-tab="veteran-sparks">Veteran Sparks</button>
            <button class="tab" data-tab="raw">Raw Data</button>
            <button class="tab" data-tab="settings">Settings</button>
            <button class="tab" data-tab="debug">Debug</button>
        </div>

        <!-- Tab: Training -->
        <div class="tab-content active" id="tab-training">
            <div class="training-topbar">
                <div class="training-topbar-left">
                    <div class="training-pill rest" id="rest-pill">REST</div>
                    <div class="training-slot">
                        <div class="training-slot-label">Turn</div>
                        <div class="training-slot-value" id="session-turn">0/0</div>
                        <div class="training-slot-sub" id="session-date">-</div>
                        <div class="training-slot-sub scenario" id="session-scenario">-</div>
                    </div>
                </div>
                <div class="training-topbar-center">
                    <div class="training-slot energy">
                        <div class="training-slot-label">Energy</div>
                        <div class="training-slot-value" id="session-energy">0/0</div>
                        <div class="energy-row">
                            <div class="energy-bar">
                                <div class="energy-fill" id="session-energy-bar"></div>
                            </div>
                        </div>
                    </div>
                    <div class="training-slot">
                        <div class="training-slot-label">Motivation</div>
                        <div class="motivation-bubble normal" id="session-motivation">Normal</div>
                    </div>
                    <div class="training-slot">
                        <div class="training-slot-label">Skill Pts</div>
                        <div class="training-slot-value" id="session-skillpts">0</div>
                    </div>
                    <div class="training-slot">
                        <div class="training-slot-label">Fans</div>
                        <div class="training-slot-value" id="session-fans">0</div>
                    </div>
                </div>
                <div class="training-topbar-right">
                    <div class="training-pill training-status">
                        <div class="training-pill-content">
                            <div class="training-pill-title">Training</div>
                            <div class="training-pill-next" id="session-next-race">Next race -</div>
                        </div>
                        <img class="training-pill-icon" id="session-next-icon" alt="next race">
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Supporters</h2>
                <div class="supporter-list" id="supporter-list"></div>
            </div>

            <div class="card">
                <h2>Training</h2>
                <div class="training-strip">
                    <div class="training-card stat-speed" id="card-speed">
                        <div class="training-card-top">
                            <span class="training-level" id="level-speed">Lv1</span>
                            <span class="training-fail fail-0" id="fail-speed">0%</span>
                        </div>
                        <div class="training-badges">
                            <span class="badge badge-hint" id="hints-speed">Hints 0</span>
                            <span class="badge badge-rainbow" id="rain-speed">Rainbows 0</span>
                            <span class="badge badge-risk hidden" id="risk-speed">High risk</span>
                            <span class="badge badge-highbond hidden" id="bond-speed">High bond</span>
                        </div>
                        <div class="training-label" id="label-speed">
                            <img class="stat-label-icon" id="label-icon-speed" src="/assets/icons/status_00.png" alt="speed">
                            <span>Speed</span>
                        </div>
                        <div class="training-rb" id="rb-speed">RB:0</div>
                        <div class="training-value">
                            <img class="stat-rank-icon" id="rank-icon-speed" src="/assets/icons/statusrank/ui_statusrank_00.png" alt="rank">
                            <span class="stat-number-group">
                                <span class="stat-main" id="stat-speed">0</span>
                                <span class="stat-sup" id="total-speed">+0</span>
                                <span class="stat-sub" id="max-speed">/1200</span>
                            </span>
                        </div>
                        <div class="training-gains" id="gains-speed">+0 SPD +0 POW</div>
                        <div class="training-metrics" id="metrics-speed">-0 ENERGY -0% FAIL</div>
                        <div class="training-hint-count" id="hintcount-speed">Hints 0</div>
                        <div class="training-unity-count" id="unitycount-speed">Useful Unity 0</div>
                        <div class="training-supporter-line" id="supporters-line-speed"></div>
                        <div class="training-breakdown" id="breakdown-speed"></div>
                        <div class="training-costs">
                            <div class="cost-item"><span class="cost-value" id="cost-energy-speed">Energy 0</span></div>
                            <div class="cost-item"><span class="cost-value" id="cost-fail-speed">Fail 0%</span></div>
                            <div class="cost-item"><span class="cost-value" id="cost-bond-speed">Bond +0</span></div>
                            <div class="cost-item"><span class="cost-value" id="cost-useful-speed">Useful +0</span></div>
                        </div>
                        <div class="training-supporters" id="supp-speed"></div>
                    </div>

                    <div class="training-card stat-stamina" id="card-stamina">
                        <div class="training-card-top">
                            <span class="training-level" id="level-stamina">Lv1</span>
                            <span class="training-fail fail-0" id="fail-stamina">0%</span>
                        </div>
                        <div class="training-badges">
                            <span class="badge badge-hint" id="hints-stamina">Hints 0</span>
                            <span class="badge badge-rainbow" id="rain-stamina">Rainbows 0</span>
                            <span class="badge badge-risk hidden" id="risk-stamina">High risk</span>
                            <span class="badge badge-highbond hidden" id="bond-stamina">High bond</span>
                        </div>
                        <div class="training-label" id="label-stamina">
                            <img class="stat-label-icon" id="label-icon-stamina" src="/assets/icons/status_01.png" alt="stamina">
                            <span>Stamina</span>
                        </div>
                        <div class="training-rb" id="rb-stamina">RB:0</div>
                        <div class="training-value">
                            <img class="stat-rank-icon" id="rank-icon-stamina" src="/assets/icons/statusrank/ui_statusrank_00.png" alt="rank">
                            <span class="stat-number-group">
                                <span class="stat-main" id="stat-stamina">0</span>
                                <span class="stat-sup" id="total-stamina">+0</span>
                                <span class="stat-sub" id="max-stamina">/1200</span>
                            </span>
                        </div>
                        <div class="training-gains" id="gains-stamina">+0 STA +0 GUT</div>
                        <div class="training-metrics" id="metrics-stamina">-0 ENERGY -0% FAIL</div>
                        <div class="training-hint-count" id="hintcount-stamina">Hints 0</div>
                        <div class="training-unity-count" id="unitycount-stamina">Useful Unity 0</div>
                        <div class="training-supporter-line" id="supporters-line-stamina"></div>
                        <div class="training-breakdown" id="breakdown-stamina"></div>
                        <div class="training-costs">
                            <div class="cost-item"><span class="cost-value" id="cost-energy-stamina">Energy 0</span></div>
                            <div class="cost-item"><span class="cost-value" id="cost-fail-stamina">Fail 0%</span></div>
                            <div class="cost-item"><span class="cost-value" id="cost-bond-stamina">Bond +0</span></div>
                            <div class="cost-item"><span class="cost-value" id="cost-useful-stamina">Useful +0</span></div>
                        </div>
                        <div class="training-supporters" id="supp-stamina"></div>
                    </div>

                    <div class="training-card stat-power" id="card-power">
                        <div class="training-card-top">
                            <span class="training-level" id="level-power">Lv1</span>
                            <span class="training-fail fail-0" id="fail-power">0%</span>
                        </div>
                        <div class="training-badges">
                            <span class="badge badge-hint" id="hints-power">Hints 0</span>
                            <span class="badge badge-rainbow" id="rain-power">Rainbows 0</span>
                            <span class="badge badge-risk hidden" id="risk-power">High risk</span>
                            <span class="badge badge-highbond hidden" id="bond-power">High bond</span>
                        </div>
                        <div class="training-label" id="label-power">
                            <img class="stat-label-icon" id="label-icon-power" src="/assets/icons/status_02.png" alt="power">
                            <span>Power</span>
                        </div>
                        <div class="training-rb" id="rb-power">RB:0</div>
                        <div class="training-value">
                            <img class="stat-rank-icon" id="rank-icon-power" src="/assets/icons/statusrank/ui_statusrank_00.png" alt="rank">
                            <span class="stat-number-group">
                                <span class="stat-main" id="stat-power">0</span>
                                <span class="stat-sup" id="total-power">+0</span>
                                <span class="stat-sub" id="max-power">/1200</span>
                            </span>
                        </div>
                        <div class="training-gains" id="gains-power">+0 POW +0 STA</div>
                        <div class="training-metrics" id="metrics-power">-0 ENERGY -0% FAIL</div>
                        <div class="training-hint-count" id="hintcount-power">Hints 0</div>
                        <div class="training-unity-count" id="unitycount-power">Useful Unity 0</div>
                        <div class="training-supporter-line" id="supporters-line-power"></div>
                        <div class="training-breakdown" id="breakdown-power"></div>
                        <div class="training-costs">
                            <div class="cost-item"><span class="cost-value" id="cost-energy-power">Energy 0</span></div>
                            <div class="cost-item"><span class="cost-value" id="cost-fail-power">Fail 0%</span></div>
                            <div class="cost-item"><span class="cost-value" id="cost-bond-power">Bond +0</span></div>
                            <div class="cost-item"><span class="cost-value" id="cost-useful-power">Useful +0</span></div>
                        </div>
                        <div class="training-supporters" id="supp-power"></div>
                    </div>

                    <div class="training-card stat-guts" id="card-guts">
                        <div class="training-card-top">
                            <span class="training-level" id="level-guts">Lv1</span>
                            <span class="training-fail fail-0" id="fail-guts">0%</span>
                        </div>
                        <div class="training-badges">
                            <span class="badge badge-hint" id="hints-guts">Hints 0</span>
                            <span class="badge badge-rainbow" id="rain-guts">Rainbows 0</span>
                            <span class="badge badge-risk hidden" id="risk-guts">High risk</span>
                            <span class="badge badge-highbond hidden" id="bond-guts">High bond</span>
                        </div>
                        <div class="training-label" id="label-guts">
                            <img class="stat-label-icon" id="label-icon-guts" src="/assets/icons/status_03.png" alt="guts">
                            <span>Guts</span>
                        </div>
                        <div class="training-rb" id="rb-guts">RB:0</div>
                        <div class="training-value">
                            <img class="stat-rank-icon" id="rank-icon-guts" src="/assets/icons/statusrank/ui_statusrank_00.png" alt="rank">
                            <span class="stat-number-group">
                                <span class="stat-main" id="stat-guts">0</span>
                                <span class="stat-sup" id="total-guts">+0</span>
                                <span class="stat-sub" id="max-guts">/1200</span>
                            </span>
                        </div>
                        <div class="training-gains" id="gains-guts">+0 GUT +0 POW +0 SPD</div>
                        <div class="training-metrics" id="metrics-guts">-0 ENERGY -0% FAIL</div>
                        <div class="training-hint-count" id="hintcount-guts">Hints 0</div>
                        <div class="training-unity-count" id="unitycount-guts">Useful Unity 0</div>
                        <div class="training-supporter-line" id="supporters-line-guts"></div>
                        <div class="training-breakdown" id="breakdown-guts"></div>
                        <div class="training-costs">
                            <div class="cost-item"><span class="cost-value" id="cost-energy-guts">Energy 0</span></div>
                            <div class="cost-item"><span class="cost-value" id="cost-fail-guts">Fail 0%</span></div>
                            <div class="cost-item"><span class="cost-value" id="cost-bond-guts">Bond +0</span></div>
                            <div class="cost-item"><span class="cost-value" id="cost-useful-guts">Useful +0</span></div>
                        </div>
                        <div class="training-supporters" id="supp-guts"></div>
                    </div>

                    <div class="training-card stat-wit" id="card-wit">
                        <div class="training-card-top">
                            <span class="training-level" id="level-wit">Lv1</span>
                            <span class="training-fail fail-0" id="fail-wit">0%</span>
                        </div>
                        <div class="training-badges">
                            <span class="badge badge-hint" id="hints-wit">Hints 0</span>
                            <span class="badge badge-rainbow" id="rain-wit">Rainbows 0</span>
                            <span class="badge badge-risk hidden" id="risk-wit">High risk</span>
                            <span class="badge badge-highbond hidden" id="bond-wit">High bond</span>
                        </div>
                        <div class="training-label" id="label-wit">
                            <img class="stat-label-icon" id="label-icon-wit" src="/assets/icons/status_04.png" alt="wit">
                            <span>Wit</span>
                        </div>
                        <div class="training-rb" id="rb-wit">RB:0</div>
                        <div class="training-value">
                            <img class="stat-rank-icon" id="rank-icon-wit" src="/assets/icons/statusrank/ui_statusrank_00.png" alt="rank">
                            <span class="stat-number-group">
                                <span class="stat-main" id="stat-wisdom">0</span>
                                <span class="stat-sup" id="total-wit">+0</span>
                                <span class="stat-sub" id="max-wit">/1200</span>
                            </span>
                        </div>
                        <div class="training-gains" id="gains-wit">+0 WIT +0 SKL</div>
                        <div class="training-metrics" id="metrics-wit">-0 ENERGY -0% FAIL</div>
                        <div class="training-hint-count" id="hintcount-wit">Hints 0</div>
                        <div class="training-unity-count" id="unitycount-wit">Useful Unity 0</div>
                        <div class="training-supporter-line" id="supporters-line-wit"></div>
                        <div class="training-breakdown" id="breakdown-wit"></div>
                        <div class="training-costs">
                            <div class="cost-item"><span class="cost-value" id="cost-energy-wit">Energy 0</span></div>
                            <div class="cost-item"><span class="cost-value" id="cost-fail-wit">Fail 0%</span></div>
                            <div class="cost-item"><span class="cost-value" id="cost-bond-wit">Bond +0</span></div>
                            <div class="cost-item"><span class="cost-value" id="cost-useful-wit">Useful +0</span></div>
                        </div>
                        <div class="training-supporters" id="supp-wit"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Stats -->
        <div class="tab-content" id="tab-stats">
            <div class="card ui-layout-item" data-ui-id="stats-card">
                <h2>Stats</h2>
                <div class="skills-header">
                    <img class="skills-portrait" id="skills-portrait" alt="portrait">
                    <div>
                        <div class="skills-name" id="skills-name">Unknown</div>
                        <div class="skills-sub" id="skills-talent">Potential Lv 0</div>
                        <div class="skills-sub" id="skills-style">Running Style: -</div>
                    </div>
                </div>

                <div class="skills-stat-strip">
                    <div class="skills-stat">
                        <div class="skills-stat-header">
                            <img class="stat-icon" id="stat-icon-speed" alt="speed">
                            <span>Speed</span>
                        </div>
                        <div class="skills-stat-body">
                            <img class="skills-rank-icon" id="rank-speed" alt="rank">
                            <div>
                                <div class="skills-stat-value" id="skills-stat-speed">0</div>
                                <div class="skills-stat-max" id="skills-max-speed">/1200</div>
                            </div>
                        </div>
                    </div>
                    <div class="skills-stat">
                        <div class="skills-stat-header">
                            <img class="stat-icon" id="stat-icon-stamina" alt="stamina">
                            <span>Stamina</span>
                        </div>
                        <div class="skills-stat-body">
                            <img class="skills-rank-icon" id="rank-stamina" alt="rank">
                            <div>
                                <div class="skills-stat-value" id="skills-stat-stamina">0</div>
                                <div class="skills-stat-max" id="skills-max-stamina">/1200</div>
                            </div>
                        </div>
                    </div>
                    <div class="skills-stat">
                        <div class="skills-stat-header">
                            <img class="stat-icon" id="stat-icon-power" alt="power">
                            <span>Power</span>
                        </div>
                        <div class="skills-stat-body">
                            <img class="skills-rank-icon" id="rank-power" alt="rank">
                            <div>
                                <div class="skills-stat-value" id="skills-stat-power">0</div>
                                <div class="skills-stat-max" id="skills-max-power">/1200</div>
                            </div>
                        </div>
                    </div>
                    <div class="skills-stat">
                        <div class="skills-stat-header">
                            <img class="stat-icon" id="stat-icon-guts" alt="guts">
                            <span>Guts</span>
                        </div>
                        <div class="skills-stat-body">
                            <img class="skills-rank-icon" id="rank-guts" alt="rank">
                            <div>
                                <div class="skills-stat-value" id="skills-stat-guts">0</div>
                                <div class="skills-stat-max" id="skills-max-guts">/1200</div>
                            </div>
                        </div>
                    </div>
                    <div class="skills-stat">
                        <div class="skills-stat-header">
                            <img class="stat-icon" id="stat-icon-wit" alt="wit">
                            <span>Wit</span>
                        </div>
                        <div class="skills-stat-body">
                            <img class="skills-rank-icon" id="rank-wit" alt="rank">
                            <div>
                                <div class="skills-stat-value" id="skills-stat-wit">0</div>
                                <div class="skills-stat-max" id="skills-max-wit">/1200</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="aptitude-grid">
                <div class="aptitude-group">
                    <div class="aptitude-title">Track</div>
                    <div class="aptitude-row">
                        <span class="apt-badge" id="apt-turf">-</span>
                        <span class="apt-badge" id="apt-dirt">-</span>
                    </div>
                </div>
                <div class="aptitude-group">
                    <div class="aptitude-title">Distance</div>
                    <div class="aptitude-row">
                        <span class="apt-badge" id="apt-sprint">-</span>
                        <span class="apt-badge" id="apt-mile">-</span>
                        <span class="apt-badge" id="apt-medium">-</span>
                        <span class="apt-badge" id="apt-long">-</span>
                    </div>
                </div>
                <div class="aptitude-group">
                    <div class="aptitude-title">Style</div>
                    <div class="aptitude-row">
                        <span class="apt-badge" id="apt-front">-</span>
                        <span class="apt-badge" id="apt-pace">-</span>
                        <span class="apt-badge" id="apt-late">-</span>
                        <span class="apt-badge" id="apt-end">-</span>
                    </div>
                </div>
                </div>

                <div class="skills-growth" id="skills-growth">
                    <span class="growth-pill">Growth: -</span>
                </div>

                <div class="skills-section">
                    <h3>Skills Current</h3>
                    <div class="skills-list" id="skills-owned">
                        <span class="skills-empty">No skills data available</span>
                    </div>
                </div>
                <div class="skills-section">
                    <h3>Skill Hints</h3>
                    <div class="skills-list" id="skills-tips">
                        <span class="skills-empty">No tips available</span>
                    </div>
                </div>
                <details class="skills-section">
                    <summary>Raw Stats JSON</summary>
                    <pre class="skills-raw" id="skills-raw-json">{}</pre>
                </details>
                <div class="skills-section">
                    <h3>Conditions</h3>
                    <div class="skills-list" id="skills-conditions">
                        <span class="skills-empty">Nothing of note</span>
                    </div>
                </div>
            </div>
        </div><!-- Tab: Race -->
        <div class="tab-content" id="tab-race">
            <div class="card ui-layout-item" data-ui-id="race-card-combined">
                <h2>Race Agenda</h2>
                <div class="race-toggle">
                    <label><input type="checkbox" id="toggle-objectives">Show objectives (separate)</label>
                    <label><input type="checkbox" id="toggle-agenda">Show agenda (separate)</label>
                </div>
                <div class="race-list" id="race-combined">
                    <span class="skills-empty">No race data available</span>
                </div>
            </div>
            <div class="card ui-layout-item" id="objective-card" style="display: none;" data-ui-id="race-card-objectives">
                <h2>Objectives (separate)</h2>
                <div class="race-list" id="objective-list">
                    <span class="skills-empty">No objectives available</span>
                </div>
            </div>
            <div class="card ui-layout-item" id="agenda-card" style="display: none;" data-ui-id="race-card-agenda">
                <h2>Race Agenda (separate)</h2>
                <div class="race-list" id="race-list">
                    <span class="skills-empty">No race data available</span>
                </div>
            </div>
            <div class="card">
                <h2>Event Choices</h2>
                <div id="event-choices">
                    <span class="skills-empty">No event choices available</span>
                </div>
            </div>
        </div>

        <!-- Tab: Misc -->
        <div class="tab-content" id="tab-misc">
            <div class="card ui-layout-item" data-ui-id="misc-card">
                <h2>Misc Data</h2>
                <div id="misc-grid" class="misc-grid">
                    <span class="skills-empty">No misc data available</span>
                </div>
            </div>
        </div>

        <!-- Tab: Veteran Umalator -->
        <div class="tab-content" id="tab-veteran-umalator">
            <div class="card ui-layout-item" id="veteran-detail-card" style="display:none;" data-ui-id="veteran-detail-card">
                <h2>Veteran Details</h2>
                <div id="veteran-detail-empty" class="skills-empty">Select a horse to view details</div>
                <div id="veteran-detail" style="display:none;">
                    <div class="skills-header">
                        <img class="skills-portrait" id="veteran-portrait" alt="portrait">
                        <div>
                    <div class="skills-name" id="veteran-name">Unknown</div>
                    <div class="skills-sub" id="veteran-rank"></div>
                    <div class="skills-sub" id="veteran-style"></div>
                    <div class="skills-section">
                        <button class="filters-button" id="veteran-uma1">Select as Uma 1</button>
                        <button class="filters-button" id="veteran-uma2">Select as Uma 2</button>
                    </div>
                </div>
            </div>

                    <div class="skills-stat-strip">
                        <div class="skills-stat">
                            <div class="skills-stat-header">
                                <img class="stat-icon" id="vstat-icon-speed" alt="speed">
                                <span>Speed</span>
                            </div>
                            <div class="skills-stat-body">
                                <img class="skills-rank-icon" id="vrank-speed" alt="rank">
                                <div>
                                    <div class="skills-stat-value" id="vstat-speed">0</div>
                                    <div class="skills-stat-max" id="vmax-speed">/1200</div>
                                </div>
                            </div>
                        </div>
                        <div class="skills-stat">
                            <div class="skills-stat-header">
                                <img class="stat-icon" id="vstat-icon-stamina" alt="stamina">
                                <span>Stamina</span>
                            </div>
                            <div class="skills-stat-body">
                                <img class="skills-rank-icon" id="vrank-stamina" alt="rank">
                                <div>
                                    <div class="skills-stat-value" id="vstat-stamina">0</div>
                                    <div class="skills-stat-max" id="vmax-stamina">/1200</div>
                                </div>
                            </div>
                        </div>
                        <div class="skills-stat">
                            <div class="skills-stat-header">
                                <img class="stat-icon" id="vstat-icon-power" alt="power">
                                <span>Power</span>
                            </div>
                            <div class="skills-stat-body">
                                <img class="skills-rank-icon" id="vrank-power" alt="rank">
                                <div>
                                    <div class="skills-stat-value" id="vstat-power">0</div>
                                    <div class="skills-stat-max" id="vmax-power">/1200</div>
                                </div>
                            </div>
                        </div>
                        <div class="skills-stat">
                            <div class="skills-stat-header">
                                <img class="stat-icon" id="vstat-icon-guts" alt="guts">
                                <span>Guts</span>
                            </div>
                            <div class="skills-stat-body">
                                <img class="skills-rank-icon" id="vrank-guts" alt="rank">
                                <div>
                                    <div class="skills-stat-value" id="vstat-guts">0</div>
                                    <div class="skills-stat-max" id="vmax-guts">/1200</div>
                                </div>
                            </div>
                        </div>
                        <div class="skills-stat">
                            <div class="skills-stat-header">
                                <img class="stat-icon" id="vstat-icon-wit" alt="wit">
                                <span>Wit</span>
                            </div>
                            <div class="skills-stat-body">
                                <img class="skills-rank-icon" id="vrank-wit" alt="rank">
                                <div>
                                    <div class="skills-stat-value" id="vstat-wit">0</div>
                                    <div class="skills-stat-max" id="vmax-wit">/1200</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="aptitude-grid">
                        <div class="aptitude-group">
                            <div class="aptitude-title">Track</div>
                            <div class="aptitude-row">
                                <span class="apt-badge" id="vapt-turf">-</span>
                                <span class="apt-badge" id="vapt-dirt">-</span>
                            </div>
                        </div>
                        <div class="aptitude-group">
                            <div class="aptitude-title">Distance</div>
                            <div class="aptitude-row">
                                <span class="apt-badge" id="vapt-sprint">-</span>
                                <span class="apt-badge" id="vapt-mile">-</span>
                                <span class="apt-badge" id="vapt-medium">-</span>
                                <span class="apt-badge" id="vapt-long">-</span>
                            </div>
                        </div>
                        <div class="aptitude-group">
                            <div class="aptitude-title">Style</div>
                            <div class="aptitude-row">
                                <span class="apt-badge" id="vapt-front">-</span>
                                <span class="apt-badge" id="vapt-pace">-</span>
                                <span class="apt-badge" id="vapt-late">-</span>
                                <span class="apt-badge" id="vapt-end">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="skills-section">
                        <h3>Skills Current</h3>
                        <div class="skills-list" id="veteran-skills">
                            <span class="skills-empty">No skills data available</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card ui-layout-item" data-ui-id="veteran-horses-card">
                <h2>Veteran Horses</h2>
                <div class="settings-row">
                    <button class="filters-button" id="veteran-filters-open">Filters</button>
                    <span class="filters-summary" id="veteran-filters-summary">No filters</span>
                </div>
                <div class="settings-row">
                    <label>Search</label>
                    <input class="settings-select" id="veteran-search" type="text" placeholder="Name, title, subtitle...">
                </div>
                <div class="settings-row">
                    <button class="filters-button" id="veteran-open-umalator">Show in Umalator</button>
                    <select class="settings-select" id="veteran-preset-select">
                        <option value="">Loading presets...</option>
                    </select>
                </div>
                <div class="umalator-slots" style="display:none;">
                    <div class="umalator-slot">
                        <strong>Uma 1</strong>
                        <div id="umalator-slot-1">No selection</div>
                    </div>
                    <div class="umalator-slot">
                        <strong>Uma 2</strong>
                        <div id="umalator-slot-2">No selection</div>
                    </div>
                </div>
                <div id="veteran-list" class="skills-list veteran-list-grid">
                    <span class="skills-empty">No veteran data available</span>
                </div>
            </div>
        </div>

        <!-- Tab: Veteran Sparks -->
        <div class="tab-content" id="tab-veteran-sparks">
            <div class="card ui-layout-item" data-ui-id="veteran-sparks-card">
                <h2>Veteran Sparks</h2>
                <span class="skills-empty">Spark sorting will live here.</span>
            </div>
        </div>

        <div class="veteran-modal" id="veteran-filters-modal" style="display:none;">
            <div class="veteran-modal-content">
                <h2>Filters</h2>
                <div class="filters-grid">
                    <div class="filters-row">
                        <span class="settings-label">Sort</span>
                        <select class="settings-select" id="veteran-sort">
                            <option value="rank_score">Rank Score</option>
                            <option value="skill_count">Skill Count</option>
                            <option value="rank">Rank</option>
                            <option value="fans">Fans</option>
                            <option value="speed">Speed</option>
                            <option value="stamina">Stamina</option>
                            <option value="power">Power</option>
                            <option value="guts">Guts</option>
                            <option value="wit">Wit</option>
                        </select>
                    </div>
                    <div class="filters-row">
                        <span class="settings-label">Order</span>
                        <select class="settings-select" id="veteran-sort-order">
                            <option value="desc">High to Low</option>
                            <option value="asc">Low to High</option>
                        </select>
                    </div>
                    <div class="filters-row">
                        <label class="filter-checkbox">
                            <input type="checkbox" id="veteran-filter-locked">
                            Show locked only
                        </label>
                    </div>
                    <div class="filters-row">
                        <label class="filter-checkbox">
                            <input type="checkbox" id="veteran-filter-favorite">
                            Show favorites only
                        </label>
                    </div>
                    <div class="filters-row">
                        <span class="settings-label">Turf >=</span>
                        <select class="settings-select" id="veteran-filter-turf"></select>
                    </div>
                    <div class="filters-row">
                        <span class="settings-label">Dirt >=</span>
                        <select class="settings-select" id="veteran-filter-dirt"></select>
                    </div>
                    <div class="filters-row">
                        <span class="settings-label">Sprint >=</span>
                        <select class="settings-select" id="veteran-filter-sprint"></select>
                    </div>
                    <div class="filters-row">
                        <span class="settings-label">Mile >=</span>
                        <select class="settings-select" id="veteran-filter-mile"></select>
                    </div>
                    <div class="filters-row">
                        <span class="settings-label">Medium >=</span>
                        <select class="settings-select" id="veteran-filter-medium"></select>
                    </div>
                    <div class="filters-row">
                        <span class="settings-label">Long >=</span>
                        <select class="settings-select" id="veteran-filter-long"></select>
                    </div>
                    <div class="filters-row">
                        <span class="settings-label">Front >=</span>
                        <select class="settings-select" id="veteran-filter-front"></select>
                    </div>
                    <div class="filters-row">
                        <span class="settings-label">Pace >=</span>
                        <select class="settings-select" id="veteran-filter-pace"></select>
                    </div>
                    <div class="filters-row">
                        <span class="settings-label">Late >=</span>
                        <select class="settings-select" id="veteran-filter-late"></select>
                    </div>
                    <div class="filters-row">
                        <span class="settings-label">End >=</span>
                        <select class="settings-select" id="veteran-filter-end"></select>
                    </div>
                </div>
                <div class="modal-actions">
                    <button id="veteran-filters-apply">Apply</button>
                    <button id="veteran-filters-close">Close</button>
                </div>
            </div>
        </div>

        <div class="veteran-modal" id="veteran-error-modal" style="display:none;">
            <div class="veteran-modal-content">
                <h2>Umalator</h2>
                <div id="veteran-error-message" class="skills-empty">Select Uma 1 and Uma 2 first.</div>
                <div class="modal-actions">
                    <button id="veteran-error-close">OK</button>
                </div>
            </div>
        </div>

        <!-- Tab: Raw Data -->
        <div class="tab-content" id="tab-raw">
            <div class="card ui-layout-item" data-ui-id="raw-card">
                <h2>Raw Game Data</h2>
                <pre id="raw-data">Waiting for data...</pre>
            </div>
        </div>

        <!-- Tab: Settings -->
        <div class="tab-content" id="tab-settings">
            <div class="card ui-layout-item" data-ui-id="settings-card">
                <h2>Settings</h2>
                <div class="settings-row">
                    <button class="filters-button" id="settings-save">Save</button>
                    <span class="filters-summary" id="settings-status">Not saved</span>
                </div>
                <div class="settings-row">
                    <span class="settings-label">Font</span>
                    <select class="settings-select" id="setting-font">
                        <option value="'Inter', 'IBM Plex Sans', system-ui, -apple-system, 'Segoe UI', sans-serif">Inter (Default)</option>
                        <option value="'IBM Plex Sans', 'Inter', system-ui, -apple-system, 'Segoe UI', sans-serif">IBM Plex Sans</option>
                        <option value="'Noto Sans JP', 'Inter', system-ui, sans-serif">Noto Sans JP</option>
                        <option value="-apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif">System Default</option>
                        <option value="'Segoe UI', sans-serif">Segoe UI</option>
                        <option value="Arial, sans-serif">Arial</option>
                        <option value="monospace">Monospace</option>
                    </select>
                </div>
                <div class="settings-row">
                    <span class="settings-label">Theme</span>
                    <select class="settings-select" id="setting-theme" disabled>
                        <option value="dark">Dark (Default)</option>
                        <option value="light">Light (Coming Soon)</option>
                    </select>
                </div>
                <div class="settings-row">
                    <span class="settings-label">Compact Mode</span>
                    <select class="settings-select" id="setting-compact" disabled>
                        <option value="off">Off (Default)</option>
                        <option value="on">On (Coming Soon)</option>
                    </select>
                </div>
                <div class="settings-subtitle">Suggested Training (Calculator)</div>
                <div class="settings-row">
                    <span class="settings-label">Calculator</span>
                    <select class="settings-select" id="setting-calc-enabled">
                        <option value="on">On</option>
                        <option value="off">Off</option>
                    </select>
                </div>
                <div class="settings-grid">
                    <div class="settings-row">
                        <span class="settings-label">Weight: Speed</span>
                        <input class="settings-select" id="setting-calc-weight-speed" type="number" step="0.1">
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Weight: Stamina</span>
                        <input class="settings-select" id="setting-calc-weight-stamina" type="number" step="0.1">
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Weight: Power</span>
                        <input class="settings-select" id="setting-calc-weight-power" type="number" step="0.1">
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Weight: Guts</span>
                        <input class="settings-select" id="setting-calc-weight-guts" type="number" step="0.1">
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Weight: Wit</span>
                        <input class="settings-select" id="setting-calc-weight-wit" type="number" step="0.1">
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Weight: Skill Pts</span>
                        <input class="settings-select" id="setting-calc-weight-skill" type="number" step="0.1" style="display:none">
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Weight: Bond</span>
                        <input class="settings-select" id="setting-calc-weight-bond" type="number" step="0.1">
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Weight: Useful Bond</span>
                        <input class="settings-select" id="setting-calc-weight-useful" type="number" step="0.1">
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Penalty: Energy</span>
                        <input class="settings-select" id="setting-calc-weight-energy" type="number" step="0.1">
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Penalty: Fail %</span>
                        <input class="settings-select" id="setting-calc-weight-fail" type="number" step="0.1">
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Threshold: Fail %</span>
                        <input class="settings-select" id="setting-calc-threshold-fail" type="number" step="1" min="0" max="100">
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Threshold: Energy</span>
                        <input class="settings-select" id="setting-calc-threshold-energy" type="number" step="1" min="0" max="100">
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Threshold: Useful Bond</span>
                        <input class="settings-select" id="setting-calc-threshold-useful" type="number" step="1" min="0" max="100">
                    </div>
                </div>
                <div class="settings-row">
                    <button class="filters-button" id="settings-advanced-toggle">Advanced Settings</button>
                </div>
                <div id="settings-advanced" style="display:none;">
                    <div class="settings-row">
                        <span class="settings-label">UDP Host</span>
                        <input class="settings-select" id="setting-udp-host" type="text">
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">UDP Port</span>
                        <input class="settings-select" id="setting-udp-port" type="number" min="1" max="65535">
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Web Host</span>
                        <input class="settings-select" id="setting-web-host" type="text">
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Web Port</span>
                        <input class="settings-select" id="setting-web-port" type="number" min="1" max="65535">
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Max Buffer Size</span>
                        <input class="settings-select" id="setting-max-buffer" type="number" min="1024">
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Log Level</span>
                        <select class="settings-select" id="setting-log-level">
                            <option value="DEBUG">DEBUG</option>
                            <option value="INFO">INFO</option>
                            <option value="WARNING">WARNING</option>
                            <option value="ERROR">ERROR</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Debug -->
        <div class="tab-content" id="tab-debug">
            <div class="card ui-layout-item" data-ui-id="debug-card">
                <h2>Debug</h2>
                <div class="info-row">
                    <span class="info-label">Last Packet</span>
                    <span id="info-packet">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Last Update</span>
                    <span id="info-update">-</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const $ = id => document.getElementById(id);
        let ws = null;
        let reconnectTimer = null;
        let lastRawData = null;
        let lastState = null;

        // Command IDs for training types
        const COMMAND_IDS = {
            speed: [101, 601, 901, 1101, 2101, 2201, 2301, 3601],
            stamina: [105, 602, 905, 1102, 2102, 2202, 2302, 3602],
            power: [102, 603, 902, 1103, 2103, 2203, 2303, 3603],
            guts: [103, 604, 903, 1104, 2104, 2204, 2304, 3604],
            wit: [106, 605, 906, 1105, 2105, 2205, 2305, 3605]
        };

        // Motivation mapping: 1=Awful, 2=Bad, 3=Normal, 4=Good, 5=Great
        const MOTIVATION = {
            1: { name: 'Awful', class: 'awful' },
            2: { name: 'Bad', class: 'bad' },
            3: { name: 'Normal', class: 'normal' },
            4: { name: 'Good', class: 'good' },
            5: { name: 'Great', class: 'great' }
        };
        const DEFAULT_CALCULATOR = {
            enabled: true,
            weights: {
                speed: 1,
                stamina: 1,
                power: 1,
                guts: 1,
                wit: 1,
                skill_pts: 0,
                bond: 0.4,
                useful_bond: 0.6,
                energy: 1,
                fail: -2
            },
            thresholds: {
                fail_pct: 20,
                energy_min: 30,
                useful_bond_min: 10
            }
        };
        let calculatorConfig = { ...DEFAULT_CALCULATOR };
        let trainingScores = {};
        const SCENARIO_NAMES = {
            1: "URA Finals",
            2: "Unity Cup",
            3: "Grand Live",
            4: "Make a New Track",
            5: "Grand Masters",
            6: "Project L'Arc",
            7: "U.A.F. Ready GO!",
            8: "Great Food Festival",
            9: "Run! Mecha Umamusume",
            10: "The Twinkle Legends",
            11: "Design Your Island",
            12: "Yukoma Hot Springs"
        };

        // Stat value to status rank icon mapping
        // Icons: 00=G, 01=G+, 02=F, 03=F+, 04=E, 05=E+, 06=D, 07=D+, 08=C, 09=C+, 10=B, 11=B+, 12=A, 13=A+, 14=S, 15=S+
        // Game thresholds: G(0-99), F(100-199), E(200-299), D(300-399), C(400-499), B(500-599), A(600-799), S(800-999), SS(1000+)
        function getStatRankIcon(statValue) {
            const val = Math.max(0, statValue);
            let iconNum;
            if (val < 100) {
                // G range: 0-99
                iconNum = val < 50 ? 0 : 1;
            } else if (val < 200) {
                // F range: 100-199
                iconNum = val < 150 ? 2 : 3;
            } else if (val < 300) {
                // E range: 200-299
                iconNum = val < 250 ? 4 : 5;
            } else if (val < 400) {
                // D range: 300-399
                iconNum = val < 350 ? 6 : 7;
            } else if (val < 500) {
                // C range: 400-499
                iconNum = val < 450 ? 8 : 9;
            } else if (val < 600) {
                // B range: 500-599
                iconNum = 10;
            } else if (val < 800) {
                // A range: 600-799
                iconNum = 12;
            } else if (val < 1000) {
                // S range: 800-999
                iconNum = 14;
            } else {
                // S+ range: 1000+
                iconNum = 15;
            }
            return `/assets/icons/statusrank/ui_statusrank_${String(iconNum).padStart(2, '0')}.png`;
        }

        function updateStatRankIcons(stats) {
            const statMap = {
                'speed': stats.speed || 0,
                'stamina': stats.stamina || 0,
                'power': stats.power || 0,
                'guts': stats.guts || 0,
                'wit': stats.wisdom || 0
            };
            for (const [stat, value] of Object.entries(statMap)) {
                const icon = $(`rank-icon-${stat}`);
                if (icon) {
                    icon.src = getStatRankIcon(value);
                }
            }
        }

        // Load saved font
        const savedFont = localStorage.getItem('bifrost-font');
        if (savedFont) {
            $('setting-font').value = savedFont;
            document.documentElement.style.setProperty('--font-family', savedFont);
            document.body.style.fontFamily = savedFont;
        } else {
            const defaultFont = "'Inter', 'IBM Plex Sans', system-ui, -apple-system, 'Segoe UI', sans-serif";
            $('setting-font').value = defaultFont;
            document.documentElement.style.setProperty('--font-family', defaultFont);
            document.body.style.fontFamily = defaultFont;
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                $('tab-' + tab.dataset.tab).classList.add('active');

                if (tab.dataset.tab === 'raw' && lastRawData) {
                    $('raw-data').textContent = JSON.stringify(lastRawData, null, 2);
                }
                if (tab.dataset.tab === 'settings') {
                    loadSettings();
                }
                if (tab.dataset.tab.startsWith('veteran')) {
                    loadVeteran();
                }
            });
        });

        $('settings-advanced-toggle')?.addEventListener('click', () => {
            const advanced = $('settings-advanced');
            if (!advanced) return;
            advanced.style.display = advanced.style.display === 'none' ? '' : 'none';
        });

        $('always-on-top-toggle')?.addEventListener('change', async (event) => {
            const enabled = event.target.checked;
            try {
                const res = await fetch('/api/always-on-top', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled, title: document.title }),
                });
                const payload = await res.json();
                if (!payload.ok) {
                    event.target.checked = !enabled;
                }
            } catch (e) {
                event.target.checked = !enabled;
            }
        });


        $('settings-save')?.addEventListener('click', async () => {
            await saveSettings();
        });

        $('veteran-sort')?.addEventListener('change', () => {
            saveVeteranFilters();
            renderVeteran();
        });
        document.querySelectorAll('[id^="veteran-filter-"]').forEach(select => {
            select.addEventListener('change', () => {
                saveVeteranFilters();
                renderVeteran();
            });
        });
        $('veteran-filters-open')?.addEventListener('click', () => {
            const modal = $('veteran-filters-modal');
            if (modal) modal.style.display = 'flex';
        });
        $('veteran-filters-close')?.addEventListener('click', () => {
            const modal = $('veteran-filters-modal');
            if (modal) modal.style.display = 'none';
        });
        $('veteran-filters-apply')?.addEventListener('click', () => {
            saveVeteranFilters();
            renderVeteran();
            const modal = $('veteran-filters-modal');
            if (modal) modal.style.display = 'none';
        });
        $('veteran-filter-locked')?.addEventListener('change', () => {
            saveVeteranFilters();
            renderVeteran();
        });
        $('veteran-filter-favorite')?.addEventListener('change', () => {
            saveVeteranFilters();
            renderVeteran();
        });
        $('veteran-search')?.addEventListener('input', () => {
            saveVeteranFilters();
            renderVeteran();
        });
        $('veteran-sort-order')?.addEventListener('change', () => {
            saveVeteranFilters();
            renderVeteran();
        });
        $('veteran-preset-select')?.addEventListener('change', (event) => {
            const value = event.target.value;
            selectedPreset = umalatorPresets.find(p => String(p.courseId) === String(value)) || umalatorPresets[0] || null;
            saveVeteranFilters();
        });

        async function loadSettings() {
            const status = $('settings-status');
            if (status) status.textContent = 'Loading...';
            try {
                const res = await fetch('/api/settings');
                const cfg = await res.json();
                $('setting-udp-host').value = cfg.udp_host || '127.0.0.1';
                $('setting-udp-port').value = cfg.udp_port || 17229;
                $('setting-web-host').value = cfg.web_host || '127.0.0.1';
                $('setting-web-port').value = cfg.web_port || 8080;
                $('setting-max-buffer').value = cfg.max_buffer_size || 262144;
                $('setting-log-level').value = cfg.log_level || 'INFO';
                const calc = cfg.calculator || {};
                const weights = calc.weights || {};
                const thresholds = calc.thresholds || {};
                $('setting-calc-enabled').value = (calc.enabled === false) ? 'off' : 'on';
                $('setting-calc-weight-speed').value = weights.speed ?? DEFAULT_CALCULATOR.weights.speed;
                $('setting-calc-weight-stamina').value = weights.stamina ?? DEFAULT_CALCULATOR.weights.stamina;
                $('setting-calc-weight-power').value = weights.power ?? DEFAULT_CALCULATOR.weights.power;
                $('setting-calc-weight-guts').value = weights.guts ?? DEFAULT_CALCULATOR.weights.guts;
                $('setting-calc-weight-wit').value = weights.wit ?? DEFAULT_CALCULATOR.weights.wit;
                $('setting-calc-weight-skill').value = weights.skill_pts ?? DEFAULT_CALCULATOR.weights.skill_pts;
                $('setting-calc-weight-bond').value = weights.bond ?? DEFAULT_CALCULATOR.weights.bond;
                $('setting-calc-weight-useful').value = weights.useful_bond ?? DEFAULT_CALCULATOR.weights.useful_bond;
                $('setting-calc-weight-energy').value = weights.energy ?? DEFAULT_CALCULATOR.weights.energy;
                $('setting-calc-weight-fail').value = weights.fail ?? DEFAULT_CALCULATOR.weights.fail;
                $('setting-calc-threshold-fail').value = thresholds.fail_pct ?? DEFAULT_CALCULATOR.thresholds.fail_pct;
                $('setting-calc-threshold-energy').value = thresholds.energy_min ?? DEFAULT_CALCULATOR.thresholds.energy_min;
                $('setting-calc-threshold-useful').value = thresholds.useful_bond_min ?? DEFAULT_CALCULATOR.thresholds.useful_bond_min;
                calculatorConfig = {
                    ...DEFAULT_CALCULATOR,
                    ...calc,
                    weights: {
                        ...DEFAULT_CALCULATOR.weights,
                        ...(weights || {}),
                        skill_pts: 0
                    },
                    thresholds: {
                        ...DEFAULT_CALCULATOR.thresholds,
                        ...(thresholds || {})
                    }
                };
                if (status) status.textContent = 'Loaded';
            } catch (e) {
                if (status) status.textContent = 'Failed to load';
            }
        }

        async function saveSettings() {
            const status = $('settings-status');
            if (status) status.textContent = 'Saving...';
            const font = $('setting-font').value;
            document.documentElement.style.setProperty('--font-family', font);
            document.body.style.fontFamily = font;
            localStorage.setItem('bifrost-font', font);

            const numOr = (id, fallback) => {
                const value = Number($(id)?.value);
                return Number.isFinite(value) ? value : fallback;
            };

            const payload = {
                udp_host: $('setting-udp-host').value || '127.0.0.1',
                udp_port: Number($('setting-udp-port').value) || 17229,
                web_host: $('setting-web-host').value || '127.0.0.1',
                web_port: Number($('setting-web-port').value) || 8080,
                max_buffer_size: Number($('setting-max-buffer').value) || 262144,
                log_level: $('setting-log-level').value || 'INFO',
                calculator: {
                    enabled: $('setting-calc-enabled').value !== 'off',
                    weights: {
                        speed: numOr('setting-calc-weight-speed', DEFAULT_CALCULATOR.weights.speed),
                        stamina: numOr('setting-calc-weight-stamina', DEFAULT_CALCULATOR.weights.stamina),
                        power: numOr('setting-calc-weight-power', DEFAULT_CALCULATOR.weights.power),
                        guts: numOr('setting-calc-weight-guts', DEFAULT_CALCULATOR.weights.guts),
                        wit: numOr('setting-calc-weight-wit', DEFAULT_CALCULATOR.weights.wit),
                        skill_pts: 0,
                        bond: numOr('setting-calc-weight-bond', DEFAULT_CALCULATOR.weights.bond),
                        useful_bond: numOr('setting-calc-weight-useful', DEFAULT_CALCULATOR.weights.useful_bond),
                        energy: numOr('setting-calc-weight-energy', DEFAULT_CALCULATOR.weights.energy),
                        fail: numOr('setting-calc-weight-fail', DEFAULT_CALCULATOR.weights.fail)
                    },
                    thresholds: {
                        fail_pct: numOr('setting-calc-threshold-fail', DEFAULT_CALCULATOR.thresholds.fail_pct),
                        energy_min: numOr('setting-calc-threshold-energy', DEFAULT_CALCULATOR.thresholds.energy_min),
                        useful_bond_min: numOr('setting-calc-threshold-useful', DEFAULT_CALCULATOR.thresholds.useful_bond_min)
                    }
                }
            };

            try {
                await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
                calculatorConfig = {
                    ...DEFAULT_CALCULATOR,
                    ...payload.calculator,
                    weights: {
                        ...DEFAULT_CALCULATOR.weights,
                        ...payload.calculator.weights,
                        skill_pts: 0
                    },
                    thresholds: {
                        ...DEFAULT_CALCULATOR.thresholds,
                        ...payload.calculator.thresholds
                    }
                };
                if (status) status.textContent = 'Saved';
            } catch (e) {
                if (status) status.textContent = 'Save failed';
            }
        }
        $('veteran-error-close')?.addEventListener('click', () => {
            const modal = $('veteran-error-modal');
            if (modal) modal.style.display = 'none';
        });
        $('veteran-open-umalator')?.addEventListener('click', () => {
            openVeteranUmalator();
        });

        $('toggle-objectives')?.addEventListener('change', () => {
            if (lastState) updateRaceTab(lastState);
        });
        $('toggle-agenda')?.addEventListener('change', () => {
            if (lastState) updateRaceTab(lastState);
        });

        function getFailClass(fail) {
            if (fail === 0) return 'fail-0';
            if (fail <= 10) return 'fail-low';
            if (fail <= 20) return 'fail-mid';
            if (fail <= 30) return 'fail-high';
            return 'fail-danger';
        }

        function getCalculatorConfig() {
            return calculatorConfig || DEFAULT_CALCULATOR;
        }

        function getMotivationPenalty(motivation) {
            if (!motivation || motivation >= 4) return 0;
            return (4 - motivation) * 6;
        }


        function bondColor(value) {
            if (value >= 100) return '#FFEB78';
            if (value >= 80) return '#FFAD1E';
            if (value >= 60) return '#A2E61E';
            return '#2AC0FF';
        }

        function findCommandInfo(commandInfoArray, commandIds) {
            if (!commandInfoArray) return null;
            for (const cmd of commandInfoArray) {
                if (commandIds.includes(cmd.command_id)) return cmd;
            }
            return null;
        }

        function getTrainingLevel(trainingLevelArray, commandId) {
            if (!trainingLevelArray) return 1;
            for (const lvl of trainingLevelArray) {
                if (lvl.command_id === commandId) return lvl.level || 1;
            }
            return 1;
        }

        function countHints(tipsArray) {
            if (!tipsArray) return 0;
            return tipsArray.length;
        }

        
        function updateTrainingCard(stat, data) {
            const raw = data.raw_data;
            if (!raw) return;
            trainingScores[stat] = null;

            const inner = raw.data || raw;
            const homeInfo = inner.home_info || {};
            const charaInfo = inner.chara_info || {};
            const commandArray = homeInfo.command_info_array || [];
            const levelArray = charaInfo.training_level_info_array || [];
            const evalArray = charaInfo.evaluation_info_array || [];
            const evalDict = {};
            for (const entry of evalArray) {
                const trainingPartnerId = entry.training_partner_id;
                const targetId = entry.target_id;
                if (trainingPartnerId !== undefined && trainingPartnerId !== null) {
                    evalDict[trainingPartnerId] = entry;
                }
                if (targetId !== undefined && targetId !== null) {
                    evalDict[targetId] = entry;
                }
            }

            const cmdIds = COMMAND_IDS[stat];
            const cmd = findCommandInfo(commandArray, cmdIds);

            if (cmd) {
                // Level
                const level = getTrainingLevel(levelArray, cmd.command_id);
                $(`level-${stat}`).textContent = `Lv${level}`;

                // Fail rate
                const fail = cmd.failure_rate || 0;
                const failEl = $(`fail-${stat}`);
                failEl.textContent = `${fail}%`;
                failEl.className = 'training-fail ' + getFailClass(fail);

                // Hints count
                const tipsSet = new Set(cmd.tips_event_partner_array || []);
                const hints = countHints(cmd.tips_event_partner_array);
                $(`hints-${stat}`).textContent = `Hints ${hints}`;
                const hintCountEl = $(`hintcount-${stat}`);
                if (hintCountEl) {
                    hintCountEl.innerHTML = `<span class="hint-text">Hints ${hints}</span>`;
                }

                // Stat gains from params_inc_dec_info_array
                const params = cmd.params_inc_dec_info_array || [];
                let statGains = { speed: 0, stamina: 0, power: 0, guts: 0, wiz: 0, skill: 0 };
                let energyChange = 0;

                const applyParams = (paramArray) => {
                    for (const p of (paramArray || [])) {
                        const target = p.target_type ?? p.status_type;
                        // target_type/status_type: 1=speed, 2=stamina, 3=power, 4=guts, 5=wiz, 30=skill
                        if (target === 1) statGains.speed += p.value || 0;
                        else if (target === 2) statGains.stamina += p.value || 0;
                        else if (target === 3) statGains.power += p.value || 0;
                        else if (target === 4) statGains.guts += p.value || 0;
                        else if (target === 5) statGains.wiz += p.value || 0;
                        else if (target === 30) statGains.skill += p.value || 0;
                        else if (target === 10) energyChange += p.value || 0;
                    }
                };

                applyParams(params);

                // Unity (Aoharu) Spirit Burst bonuses can be delivered via team_data_set command arrays.
                if (inner?.chara_info?.scenario_id === 2) {
                    const teamData = inner?.team_data_set || {};
                    const teamCmd = (teamData.command_info_array || [])
                        .find(info => info.command_id === cmd.command_id);
                    if (teamCmd) {
                        const extraKeys = [
                            "params_inc_dec_info_array",
                            "point_up_info_array",
                            "add_params_info_array",
                            "add_params_inc_dec_info_array",
                            "bonus_params_inc_dec_info_array",
                        ];
                        for (const key of extraKeys) {
                            applyParams(teamCmd[key]);
                        }
                    }
                }

                // Primary + secondary gains for this training
                const primaryMap = { speed: 'speed', stamina: 'stamina', power: 'power', guts: 'guts', wit: 'wiz' };
                const secondaryMap = { speed: 'power', stamina: 'guts', power: 'stamina', guts: 'power', wit: 'skill' };
                const extraMap = { guts: 'speed' };
                const primaryGain = statGains[primaryMap[stat]] || 0;
                const secondaryGain = statGains[secondaryMap[stat]] || 0;
                const extraGain = statGains[extraMap[stat]] || 0;
                const totalGain = primaryGain + secondaryGain + extraGain;

                const totalEl = $(`total-${stat}`);
                totalEl.textContent = totalGain > 0 ? `+${totalGain}` : '+0';

                const gainsMap = {
                    speed: [
                        { label: 'SPD', value: statGains.speed },
                        { label: 'POW', value: statGains.power }
                    ],
                    stamina: [
                        { label: 'STA', value: statGains.stamina },
                        { label: 'GUT', value: statGains.guts }
                    ],
                    power: [
                        { label: 'STA', value: statGains.stamina },
                        { label: 'POW', value: statGains.power }
                    ],
                    guts: [
                        { label: 'SPD', value: statGains.speed },
                        { label: 'POW', value: statGains.power },
                        { label: 'GUT', value: statGains.guts }
                    ],
                    wit: [
                        { label: 'SPD', value: statGains.speed },
                        { label: 'WIT', value: statGains.wiz }
                    ]
                };
                const gainsEl = $(`gains-${stat}`);
                if (gainsEl && gainsMap[stat]) {
                    const line = gainsMap[stat]
                        .map(item => `<span class="gain-value">+${item.value || 0}</span> <span class="gain-label">${item.label}</span>`)
                        .join(' ');
                    gainsEl.innerHTML = line;
                }
                const metricsEl = $(`metrics-${stat}`);
                if (metricsEl) {
                    const energyValue = energyChange || 0;
                    const energyClass = energyValue >= 0 ? 'energy-pos' : 'energy-neg';
                    const energyText = energyValue >= 0 ? `+${energyValue}` : `${energyValue}`;
                    const failClass = getFailClass(fail);
                    const failText = fail > 0 ? `${fail}%` : '0%';
                    metricsEl.innerHTML =
                        `<span class="${energyClass}"><span class="energy-value">${energyText}</span> ENERGY</span> ` +
                        `<span class="${failClass}">${failText} FAIL</span>`;
                }

                // Rainbow count: support card type must match training stat, bond >= 80, exclude pal/friend.
                const partnerArray = cmd.training_partner_array || [];
                let rainbows = 0;
                for (const partnerId of partnerArray) {
                    if (partnerId > 6) continue;
                    const entry = evalDict[partnerId];
                    const supporter = (data.supporters || []).find(s => s.position === partnerId);
                    if (!supporter) continue;
                    if (PAL_SUPPORT_IDS.has(supporter.support_card_id)) continue;
                    if (supporter.support_card_type === 2 || supporter.support_card_type === 3) continue;
                    const evaluation = entry?.evaluation ?? supporter.bond ?? 0;
                    if (evaluation < 80) continue;
                    const cmdList = COMMAND_IDS[stat] || [];
                    const supportCmdId = Number(supporter.support_card_command_id);
                    if (Number.isFinite(supportCmdId) && supportCmdId > 0 && !cmdList.includes(supportCmdId)) continue;
                    rainbows += 1;
                }
                $(`rain-${stat}`).textContent = `Rainbows ${rainbows}`;
                const rbEl = $(`rb-${stat}`);
                if (rbEl) {
                    rbEl.textContent = `RB:${rainbows}`;
                    rbEl.classList.toggle('zeroed', rainbows === 0);
                    rbEl.classList.toggle('rainbow', rainbows > 0);
                }

                // Rainbow gradient on label if rainbows > 0
                const labelEl = $(`label-${stat}`);
                const iconEl = $(`label-icon-${stat}`);
                if (rainbows > 0) {
                    labelEl.classList.add('rainbow');
                    if (iconEl) iconEl.classList.add('rainbow');
                } else {
                    labelEl.classList.remove('rainbow');
                    if (iconEl) iconEl.classList.remove('rainbow');
                }
                // Projected stat display removed

                const maxMap = {
                    speed: 'max_speed',
                    stamina: 'max_stamina',
                    power: 'max_power',
                    guts: 'max_guts',
                    wit: 'max_wiz'
                };
                const maxVal = charaInfo[maxMap[stat]] || 1200;
                const maxEl = $(`max-${stat}`);
                if (maxEl) maxEl.textContent = `/${maxVal}`;
                const breakdownEl = $(`breakdown-${stat}`);
                if (breakdownEl) {
                    const abbrMap = {
                        speed: "SPD",
                        stamina: "STA",
                        power: "POW",
                        guts: "GUT",
                        wit: "WIT",
                        skill: "SKL",
                    };
                    const primaryAbbr = abbrMap[primaryMap[stat]];
                    const secondaryAbbr = abbrMap[secondaryMap[stat]];
                    const extraAbbr = extraMap[stat] ? abbrMap[extraMap[stat]] : null;

                    const parts = [];
                    if (primaryAbbr && primaryGain) parts.push(`<span class="breakdown-stat">+${primaryGain} ${primaryAbbr}</span>`);
                    if (secondaryAbbr && secondaryGain) parts.push(`<span class="breakdown-stat">+${secondaryGain} ${secondaryAbbr}</span>`);
                    if (extraAbbr && extraGain) parts.push(`<span class="breakdown-stat">+${extraGain} ${extraAbbr}</span>`);

                    breakdownEl.innerHTML = parts.join('');
                }

                let bondGain = 0;
                for (const partnerId of partnerArray) {
                    if (partnerId > 6) continue;
                    const evaluation = evalDict[partnerId]?.evaluation ?? 0;
                    let gain = tipsSet.has(partnerId) ? 12 : 7;
                    gain = Math.min(gain, Math.max(0, 100 - evaluation));
                    bondGain += gain;
                }

                const reasonResult = updateReasons(stat, statGains, partnerArray, evalDict, charaInfo, tipsSet);
                if (hintCountEl) {
                    const hintZero = hints === 0;
                    const bondZero = reasonResult.usefulBond === 0;
                    hintCountEl.innerHTML =
                        `<span class="hint-text${hintZero ? ' zeroed' : ''}">Hints ${hints}</span> ` +
                        `<span class="bond-text${bondZero ? ' zeroed' : ''}">Bonds +${reasonResult.usefulBond}</span>`;
                }
                const unityEl = $(`unitycount-${stat}`);
                if (unityEl) {
                    const scenarioId = inner?.chara_info?.scenario_id;
                    if (scenarioId !== 2) {
                        unityEl.style.display = 'none';
                    } else {
                        const teamData = inner?.team_data_set || {};
                        const unityCmd = (teamData.command_info_array || [])
                            .find(info => info.command_id === cmd.command_id);
                        const guidePartners = unityCmd?.guide_event_partner_array || [];
                        const evalInfo = teamData.evaluation_info_array || [];
                        const evalByTarget = {};
                        for (const entry of evalInfo) {
                            evalByTarget[entry.target_id] = entry;
                        }
                        let usefulUnity = 0;
                        for (const partnerId of guidePartners) {
                            const evalEntry = evalByTarget[partnerId];
                            if (evalEntry && evalEntry.soul_event_state === 0) {
                                usefulUnity += 1;
                            }
                        }
                        unityEl.style.display = '';
                        const burstCount = (unityCmd?.soul_event_partner_array || []).length;
                        const unityZero = usefulUnity === 0;
                        const burstZero = burstCount === 0;
                        unityEl.innerHTML =
                            `<span class="${unityZero ? 'zeroed' : ''}">Unity T: ${usefulUnity}</span> ` +
                            `<span class="spirit-text${burstZero ? ' zeroed' : ''}">Burst ${burstCount}</span>`;
                    }
                }
                updateTrainingSupporters(stat, partnerArray, evalDict, data, cmd);

                const calc = getCalculatorConfig();
                const weights = calc.weights || {};
                const baseScore =
                    (statGains.speed || 0) * (weights.speed ?? 0) +
                    (statGains.stamina || 0) * (weights.stamina ?? 0) +
                    (statGains.power || 0) * (weights.power ?? 0) +
                    (statGains.guts || 0) * (weights.guts ?? 0) +
                    (statGains.wiz || 0) * (weights.wit ?? 0) +
                    bondGain * (weights.bond ?? 0) +
                    reasonResult.usefulBond * (weights.useful_bond ?? 0) +
                    (energyChange || 0) * (weights.energy ?? 0) +
                    fail * (weights.fail ?? 0);
                const motivationPenalty = getMotivationPenalty(data?.training?.stats?.motivation);
                trainingScores[stat] = baseScore - motivationPenalty;

                const costEnergy = $(`cost-energy-${stat}`);
                if (costEnergy) {
                    const value = energyChange || 0;
                    const label = value >= 0 ? `Energy +${value}` : `Energy ${value}`;
                    costEnergy.textContent = label;
                    costEnergy.classList.remove('low', 'mid', 'high');
                    const abs = Math.abs(value);
                    if (abs <= 10) costEnergy.classList.add('low');
                    else if (abs <= 20) costEnergy.classList.add('mid');
                    else costEnergy.classList.add('high');
                }
                const costFail = $(`cost-fail-${stat}`);
                if (costFail) {
                    costFail.textContent = `Fail ${fail}%`;
                }
                const costBond = $(`cost-bond-${stat}`);
                if (costBond) {
                    costBond.textContent = `Bond +${bondGain}`;
                }
                const costUseful = $(`cost-useful-${stat}`);
                if (costUseful) {
                    costUseful.textContent = `Useful +${reasonResult.usefulBond}`;
                    const holder = costUseful.parentElement;
                    if (holder) {
                        holder.classList.toggle('hidden', reasonResult.usefulBond <= 0);
                    }
                }

                const riskBadge = $(`risk-${stat}`);
                if (riskBadge) {
                    riskBadge.classList.toggle('hidden', fail < 20);
                }
                const bondBadge = $(`bond-${stat}`);
                if (bondBadge) {
                    bondBadge.classList.toggle('hidden', reasonResult.usefulBond < 10);
                }
            }
        }

        const PAL_SUPPORT_IDS = new Set([
            30160, // Mei Satake (friend)
            30052, // Light Hello (friend)
            30188  // Ryoka (friend)
        ]);

        function updateReasons(stat, gains, partners, evalDict, charaInfo, tipsSet) {
            // Map stat to its secondary stat display
            const reasonMaps = {
                speed: { primary: 'spd', secondary: 'pow', pGain: gains.speed, sGain: gains.power },
                stamina: { primary: 'sta', secondary: 'gut', pGain: gains.stamina, sGain: gains.guts },
                power: { primary: 'pow', secondary: 'sta', pGain: gains.power, sGain: gains.stamina },
                guts: { primary: 'gut', secondary: 'pow', pGain: gains.guts, sGain: gains.power },
                wit: { primary: 'wiz', secondary: 'skl', pGain: gains.wiz, sGain: gains.skill }
            };

            const map = reasonMaps[stat];
            if (!map) return { usefulBond: 0, hasPal: false };

            // Primary stat gain
            const pEl = $(`r-${stat}-${map.primary}`);
            if (pEl) {
                pEl.textContent = map.pGain > 0 ? `+${map.pGain}` : '+0';
                pEl.classList.toggle('negative', map.pGain < 0);
            }

            // Secondary stat gain
            const sEl = $(`r-${stat}-${map.secondary}`);
            if (sEl) {
                sEl.textContent = map.sGain > 0 ? `+${map.sGain}` : '+0';
                sEl.classList.toggle('negative', map.sGain < 0);
            }

            const supportByPos = {};
            for (const card of (charaInfo?.support_card_array || [])) {
                supportByPos[card.position] = card.support_card_id;
            }

            // Useful bond: if below threshold, count the full gain (7 or 12), even if it crosses the threshold.
            let usefulBond = 0;
            let hasPal = false;
            for (const partnerId of partners) {
                const entry = evalDict[partnerId];
                if (!entry) continue;

                const evaluation = entry.evaluation || 0;
                const isSupport = partnerId <= 6;
                const supportId = supportByPos[partnerId];
                const isPal = isSupport && supportId && PAL_SUPPORT_IDS.has(supportId);

                const gain = tipsSet && tipsSet.has(partnerId) ? 12 : 7;
                const cappedGain = Math.min(gain, Math.max(0, 100 - evaluation));
                if (isPal) {
                    hasPal = true;
                    if (evaluation < 60) usefulBond += cappedGain;
                } else if (isSupport) {
                    if (evaluation < 80) usefulBond += cappedGain;
                }
            }

            const bondEl = $(`r-${stat}-bond`);
            if (bondEl) bondEl.textContent = usefulBond > 0 ? `+${usefulBond}` : '+0';

            return { usefulBond, hasPal };
        }

        
        function updateTrainingSupporters(stat, partnerArray, evalDict, state, cmd) {
            const container = $(`supporters-line-${stat}`) || $(`supp-${stat}`);
            if (!container) return;
            container.innerHTML = '';

            const supporters = state.supporters || [];
            const tips = new Set(cmd?.tips_event_partner_array || []);

            for (const partnerId of (partnerArray || [])) {
                if (partnerId > 6) continue; // only support cards for now
                const supporter = supporters.find(s => s.position === partnerId);
                if (!supporter) continue;

                const evaluation = evalDict[partnerId]?.evaluation ?? supporter.bond ?? 0;
                const maxPossible = Math.min(100, 100 - evaluation);
                let gain = Math.min(7, maxPossible);
                if (tips.has(partnerId)) {
                    gain = Math.min(7 + 5, maxPossible);
                }

                const chip = document.createElement('div');
                chip.className = 'supporter-chip';

                const img = document.createElement('img');
                img.src = supporter.icon_url || 'https://umapyoi.net/missing_chara.png';
                img.alt = supporter.name || 'Supporter';

                const text = document.createElement('span');
                const resultBond = Math.min(100, evaluation + gain);
                text.textContent = `+${gain}`;
                text.style.color = bondColor(resultBond);

                chip.appendChild(img);
                chip.appendChild(text);

                if (tips.has(partnerId)) {
                    const badge = document.createElement('div');
                    badge.className = 'hint-badge';
                    badge.textContent = '!';
                    chip.appendChild(badge);
                }

                container.appendChild(chip);
            }

            if (!container.children.length) {
                container.textContent = '';
            }
        }

        function applySuggestedTraining(state) {
            const calc = getCalculatorConfig();
            const restPill = $('rest-pill');
            document.querySelectorAll('.training-card').forEach(card => card.classList.remove('suggested'));
            if (restPill) restPill.classList.remove('suggested');

            if (!calc.enabled) {
                const suggested = state?.training?.suggested_training || state?.training?.suggested_command || state?.training?.suggested;
                if (suggested && $(`card-${suggested}`)) {
                    $(`card-${suggested}`).classList.add('suggested');
                }
                return;
            }

            let bestStat = null;
            let bestScore = -Infinity;
            for (const [stat, score] of Object.entries(trainingScores)) {
                if (score === null || score === undefined) continue;
                if (score > bestScore) {
                    bestScore = score;
                    bestStat = stat;
                }
            }

            const energy = state?.training?.stats?.energy ?? 0;
            const motivation = state?.training?.stats?.motivation ?? 3;
            const thresholds = calc.thresholds || {};
            const energyMin = thresholds.energy_min ?? DEFAULT_CALCULATOR.thresholds.energy_min;
            const motivationPenalty = getMotivationPenalty(motivation);
            let restScore = 0;
            if (energy < energyMin) {
                restScore += (energyMin - energy) * 2;
            }
            if (motivationPenalty > 0) {
                restScore += motivationPenalty * 1.5;
            }

            if (restPill && (restScore >= bestScore || bestStat === null)) {
                restPill.classList.add('suggested');
            } else if (bestStat && $(`card-${bestStat}`)) {
                $(`card-${bestStat}`).classList.add('suggested');
            }
        }

function updateSupporters(state) {
            const list = $('supporter-list');
            if (!list) return;
            list.innerHTML = '';

            const supporters = state.supporters || [];
            const raw = state.raw_data?.data || state.raw_data || {};
            const commandInfo = raw?.home_info?.command_info_array || [];
            const hintPartners = new Set();
            for (const cmd of commandInfo) {
                for (const partnerId of (cmd.tips_event_partner_array || [])) {
                    hintPartners.add(partnerId);
                }
            }
            if (!supporters.length) {
                const empty = document.createElement('span');
                empty.className = 'skills-empty';
                empty.textContent = 'No supporters data available';
                list.appendChild(empty);
                return;
            }

            for (const supporter of supporters) {
                const item = document.createElement('div');
                item.className = 'supporter-item';

                const img = document.createElement('img');
                img.src = supporter.icon_url || 'https://umapyoi.net/missing_chara.png';
                img.alt = supporter.name || 'Supporter';
                if (hintPartners.has(supporter.position)) {
                    const hintIcon = document.createElement('img');
                    hintIcon.className = 'supporter-hint-icon';
                    hintIcon.src = '/assets/icons/hint.png';
                    hintIcon.alt = 'Hint';
                    item.appendChild(hintIcon);
                }

                const bondValue = supporter.bond ?? 0;
                const bond = document.createElement('div');
                bond.className = 'supporter-bond';
                bond.textContent = bondValue;
                bond.style.color = bondColor(bondValue);

                const bar = document.createElement('div');
                bar.className = 'supporter-bond-bar';
                const fill = document.createElement('div');
                fill.className = 'supporter-bond-fill';
                fill.style.width = `${Math.min(100, Math.max(0, bondValue))}%`;
                fill.style.background = bondColor(bondValue);
                bar.appendChild(fill);

                const name = document.createElement('div');
                name.className = 'supporter-name';
                name.textContent = supporter.name || `Support ${supporter.support_card_id}`;

                item.appendChild(img);
                item.appendChild(bond);
                item.appendChild(bar);
                item.appendChild(name);
                list.appendChild(item);
            }
        }

        function updateSkillsTab(state) {
            const data = state.skills_tab || {};
            if (!Object.keys(data).length) return;

            const portrait = $('skills-portrait');
            portrait.src = data.portrait_url || 'https://umapyoi.net/missing_chara.png';
            portrait.onerror = () => {
                portrait.onerror = null;
                portrait.src = data.portrait_fallback_url || 'https://umapyoi.net/missing_chara.png';
            };

            $('skills-name').textContent = data.chara_name || 'Unknown';
            $('skills-talent').textContent = `Potential Lv ${data.talent_level ?? '-'}`;
            $('skills-style').textContent = `Running Style: ${data.running_style || '-'}`;

            const stats = state.training?.stats || {};
            $('skills-stat-speed').textContent = stats.speed ?? 0;
            $('skills-stat-stamina').textContent = stats.stamina ?? 0;
            $('skills-stat-power').textContent = stats.power ?? 0;
            $('skills-stat-guts').textContent = stats.guts ?? 0;
            $('skills-stat-wit').textContent = stats.wisdom ?? 0;

            const raw = state.raw_data?.data || state.raw_data || {};
            const maxStats = raw?.chara_info || {};
            $('skills-max-speed').textContent = `/${maxStats.max_speed ?? 1200}`;
            $('skills-max-stamina').textContent = `/${maxStats.max_stamina ?? 1200}`;
            $('skills-max-power').textContent = `/${maxStats.max_power ?? 1200}`;
            $('skills-max-guts').textContent = `/${maxStats.max_guts ?? 1200}`;
            $('skills-max-wit').textContent = `/${maxStats.max_wiz ?? 1200}`;

            const statIconMap = {
                speed: '/assets/icons/status_00.png',
                stamina: '/assets/icons/status_01.png',
                power: '/assets/icons/status_02.png',
                guts: '/assets/icons/status_03.png',
                wit: '/assets/icons/status_04.png',
            };
            $('stat-icon-speed').src = statIconMap.speed;
            $('stat-icon-stamina').src = statIconMap.stamina;
            $('stat-icon-power').src = statIconMap.power;
            $('stat-icon-guts').src = statIconMap.guts;
            $('stat-icon-wit').src = statIconMap.wit;

            const statRankIndex = (value) => {
                const val = Number(value || 0);
                return Math.min(97, Math.floor(val / 50));
            };
            const rankIcon = (idx) => `/assets/icons/statusrank/ui_statusrank_${String(idx).padStart(2, '0')}.png`;
            $('rank-speed').src = rankIcon(statRankIndex(stats.speed));
            $('rank-stamina').src = rankIcon(statRankIndex(stats.stamina));
            $('rank-power').src = rankIcon(statRankIndex(stats.power));
            $('rank-guts').src = rankIcon(statRankIndex(stats.guts));
            $('rank-wit').src = rankIcon(statRankIndex(stats.wisdom));

            const apt = data.aptitudes || {};
            const aptIconIndex = {
                'G': 0, 'G+': 1, 'F': 2, 'F+': 3, 'E': 4, 'E+': 5,
                'D': 6, 'D+': 7, 'C': 8, 'C+': 9, 'B': 10, 'B+': 11,
                'A': 12, 'A+': 13, 'S': 14,
            };
            const aptIcon = (letter) => {
                const idx = aptIconIndex[letter] ?? 0;
                return `/assets/icons/statusrank/ui_statusrank_${String(idx).padStart(2, '0')}.png`;
            };
            const setApt = (id, letter, label) => {
                const el = $(id);
                if (!el) return;
                const value = letter || '-';
                el.innerHTML = `<span>${label}</span><img class="apt-icon" src="${aptIcon(value)}" alt="${value}">`;
            };
            setApt('apt-turf', apt.track?.Turf, 'Turf');
            setApt('apt-dirt', apt.track?.Dirt, 'Dirt');
            setApt('apt-sprint', apt.distance?.Sprint, 'Sprint');
            setApt('apt-mile', apt.distance?.Mile, 'Mile');
            setApt('apt-medium', apt.distance?.Medium, 'Medium');
            setApt('apt-long', apt.distance?.Long, 'Long');
            setApt('apt-front', apt.style?.Front, 'Front');
            setApt('apt-pace', apt.style?.Pace, 'Pace');
            setApt('apt-late', apt.style?.Late, 'Late');
            setApt('apt-end', apt.style?.End, 'End');

            const growth = $('skills-growth');
            growth.innerHTML = '';
            const growthRates = data.growth_rates || {};
            const growthKeys = [
                ['Speed', growthRates.speed, statIconMap.speed],
                ['Stamina', growthRates.stamina, statIconMap.stamina],
                ['Power', growthRates.power, statIconMap.power],
                ['Guts', growthRates.guts, statIconMap.guts],
                ['Wit', growthRates.wit, statIconMap.wit],
            ];
            const anyGrowth = growthKeys.some(([, val]) => val && val !== 0);
            if (anyGrowth) {
                for (const [label, value, icon] of growthKeys) {
                    if (!value) continue;
                    const pill = document.createElement('span');
                    pill.className = 'growth-pill';
                    pill.innerHTML = `<img class="stat-icon" src="${icon}" alt="${label}"> +${value}%`;
                    growth.appendChild(pill);
                }
            } else {
                const pill = document.createElement('span');
                pill.className = 'growth-pill';
                pill.textContent = 'Growth: -';
                growth.appendChild(pill);
            }

            const owned = $('skills-owned');
            owned.innerHTML = '';
            if (data.skills && data.skills.length) {
                for (const skill of data.skills) {
                    const item = document.createElement('div');
                    item.className = 'skill-item';
                    const img = document.createElement('img');
                    img.className = 'skill-icon';
                    img.src = skill.icon_url || '';
                    img.alt = skill.name || 'Skill';
                    const text = document.createElement('div');
                    text.className = 'skill-text';
                    text.textContent = `${skill.name} Lv ${skill.level}`;
                    item.appendChild(img);
                    item.appendChild(text);
                    owned.appendChild(item);
                }
            } else {
                const empty = document.createElement('span');
                empty.className = 'skills-empty';
                empty.textContent = 'No skills data available';
                owned.appendChild(empty);
            }

            const tips = $('skills-tips');
            tips.innerHTML = '';
            if (data.skill_tips && data.skill_tips.length) {
                for (const tip of data.skill_tips) {
                    const item = document.createElement('div');
                    item.className = 'skill-item';
                    const img = document.createElement('img');
                    img.className = 'skill-icon';
                    img.src = tip.icon_url || '';
                    img.alt = tip.name || 'Tip';
                    const text = document.createElement('div');
                    text.className = 'skill-text';
                    text.textContent = `${tip.name} HINT Lv ${tip.level}`;
                    const hint = document.createElement('img');
                    hint.className = 'skill-hint-icon';
                    hint.src = '/assets/icons/hint.png';
                    hint.alt = 'Hint';
                    item.appendChild(img);
                    item.appendChild(text);
                    item.appendChild(hint);
                    tips.appendChild(item);
                }
            } else {
                const empty = document.createElement('span');
                empty.className = 'skills-empty';
                empty.textContent = 'No tips available';
                tips.appendChild(empty);
            }

            const rawJson = $('skills-raw-json');
            if (rawJson) {
                const compactSkills = (data.skills || []).map(({ icon_url, ...rest }) => rest);
                const compactHints = (data.skill_tips || []).map(({ icon_url, ...rest }) => rest);
                rawJson.textContent = JSON.stringify({
                    chara: {
                        id: data.chara_id ?? null,
                        name: data.chara_name ?? null,
                    },
                    stats: {
                        speed: stats.speed ?? 0,
                        stamina: stats.stamina ?? 0,
                        power: stats.power ?? 0,
                        guts: stats.guts ?? 0,
                        wit: stats.wisdom ?? 0,
                        skill_pts: stats.skill_pts ?? 0,
                        energy: stats.energy ?? 0,
                        motivation: stats.motivation ?? 0,
                    },
                    aptitudes: data.aptitudes || {},
                    skills: compactSkills,
                    skill_hints: compactHints,
                }, null, 2);
            }

            const conditions = $('skills-conditions');
            conditions.innerHTML = '';
            if (data.conditions && data.conditions.length) {
                for (const cond of data.conditions) {
                    const tag = document.createElement('span');
                    tag.className = 'skill-tag';
                    tag.textContent = `Effect ${cond}`;
                    conditions.appendChild(tag);
                }
            } else {
                const empty = document.createElement('span');
                empty.className = 'skills-empty';
                empty.textContent = 'Nothing of note';
                conditions.appendChild(empty);
            }
        }

        function classFromTurn(turn) {
            if (!turn) return null;
            if (turn >= 49) return 'Senior';
            if (turn >= 25) return 'Classic';
            if (turn >= 13) return 'Junior';
            return 'Pre-Debut';
        }

        function classFromYear(year) {
            const yr = Number(year);
            if (yr === 1) return 'Junior';
            if (yr === 2) return 'Classic';
            if (yr === 3) return 'Senior';
            return null;
        }

        function racePill(label, iconUrl, options = {}) {
            const pill = document.createElement('span');
            pill.className = 'race-pill';
            if (options.className) {
                pill.classList.add(options.className);
            }
            if (iconUrl) {
                const img = document.createElement('img');
                img.className = 'race-pill-icon';
                img.src = iconUrl;
                img.alt = label || '';
                pill.appendChild(img);
            }
            if (label) {
                const text = document.createElement('span');
                text.textContent = label;
                pill.appendChild(text);
            }
            return pill;
        }

        function seasonFromMonth(month) {
            if (!month) return null;
            const m = Number(month);
            if ([12, 1, 2].includes(m)) {
                return { label: 'Winter', icon: '/assets/icons/utx_txt_season_03.png' };
            }
            if ([3, 4, 5].includes(m)) {
                return { label: 'Spring', icon: '/assets/icons/utx_txt_season_00.png' };
            }
            if ([6, 7, 8].includes(m)) {
                return { label: 'Summer', icon: '/assets/icons/utx_txt_season_01.png' };
            }
            return { label: 'Autumn', icon: '/assets/icons/utx_txt_season_02.png' };
        }

        function seasonFromValue(value) {
            const map = {
                1: { label: 'Spring', icon: '/assets/icons/utx_txt_season_00.png' },
                2: { label: 'Summer', icon: '/assets/icons/utx_txt_season_01.png' },
                3: { label: 'Autumn', icon: '/assets/icons/utx_txt_season_02.png' },
                4: { label: 'Winter', icon: '/assets/icons/utx_txt_season_03.png' },
            };
            return map[Number(value)] || null;
        }

        function weatherFromValue(value) {
            const map = {
                0: { label: 'Sunny', icon: '/assets/icons/utx_ico_weather_00.png' },
                1: { label: 'Cloudy', icon: '/assets/icons/utx_ico_weather_01.png' },
                2: { label: 'Rainy', icon: '/assets/icons/utx_ico_weather_02.png' },
                3: { label: 'Snowy', icon: '/assets/icons/utx_ico_weather_03.png' },
            };
            return map[Number(value)] || null;
        }

        function timeFromValue(value) {
            const map = {
                0: { label: 'Daytime', icon: '/assets/icons/utx_ico_timezone_00.png' },
                1: { label: 'Evening', icon: '/assets/icons/utx_ico_timezone_01.png' },
                2: { label: 'Night', icon: '/assets/icons/utx_ico_timezone_02.png' },
            };
            return map[Number(value)] || null;
        }

        function groundConditionFromValue(value) {
            const map = {
                1: 'Firm',
                2: 'Good',
                3: 'Soft',
                4: 'Heavy',
            };
            return map[Number(value)] || null;
        }

        function monthToSeasonValue(month) {
            if (!month) return null;
            const m = Number(month);
            if ([3, 4, 5].includes(m)) return 1;
            if ([6, 7, 8].includes(m)) return 2;
            if ([9, 10, 11].includes(m)) return 3;
            return 4;
        }

        async function encodeUmalatorState(payload) {
            if (!('CompressionStream' in window)) return null;
            const json = JSON.stringify(payload);
            const encoded = new TextEncoder().encode(json);
            const stream = new ReadableStream({
                start(controller) {
                    controller.enqueue(encoded);
                    controller.close();
                }
            }).pipeThrough(new CompressionStream('gzip'));
            const reader = stream.getReader();
            const chunks = [];
            let total = 0;
            for (;;) {
                const { value, done } = await reader.read();
                if (done) break;
                chunks.push(value);
                total += value.length;
            }
            const buffer = new Uint8Array(total);
            let offset = 0;
            for (const chunk of chunks) {
                buffer.set(chunk, offset);
                offset += chunk.length;
            }
            let binary = '';
            for (let i = 0; i < buffer.length; i++) {
                binary += String.fromCharCode(buffer[i]);
            }
            return encodeURIComponent(btoa(binary));
        }

        function distanceTypeFromMeters(meters) {
            if (!meters) return null;
            const m = Number(meters);
            if (m <= 1400) return 'Sprint';
            if (m <= 1800) return 'Mile';
            if (m <= 2400) return 'Medium';
            return 'Long';
        }

        function surfaceLabelFromGround(ground) {
            return Number(ground) === 2 ? 'Dirt' : 'Turf';
        }

        async function openUmalator(item) {
            if (!item?.course_set || !lastState) {
                window.open('https://alpha123.github.io/uma-tools/umalator-global/', '_blank');
                return;
            }
            const skillsTab = lastState.skills_tab || {};
            const stats = lastState.training?.stats || {};
            const aptitudes = skillsTab.aptitudes || {};
            const runningStyle = skillsTab.running_style || 'Pace';
            const styleMap = {
                Front: { strategy: 'Nige', label: 'Front' },
                Pace: { strategy: 'Senkou', label: 'Pace' },
                Late: { strategy: 'Sasi', label: 'Late' },
                End: { strategy: 'Oikomi', label: 'End' },
            };
            const style = styleMap[runningStyle] || styleMap.Pace;
            const distanceType = item.distance_type || null;
            const surfaceLabel = item.ground_label || (item.ground === 1 ? 'Turf' : 'Dirt');

            const uma1 = {
                outfitId: skillsTab.card_id ? String(skillsTab.card_id) : '',
                speed: stats.speed ?? 0,
                stamina: stats.stamina ?? 0,
                power: stats.power ?? 0,
                guts: stats.guts ?? 0,
                wisdom: stats.wisdom ?? 0,
                strategy: style.strategy,
                distanceAptitude: aptitudes.distance?.[distanceType] || 'A',
                surfaceAptitude: aptitudes.track?.[surfaceLabel] || 'A',
                strategyAptitude: aptitudes.style?.[style.label] || 'A',
                skills: (skillsTab.skills || []).map(s => s.id ?? s.skill_id).filter(Boolean),
            };

            const seasonValue = item.season ?? monthToSeasonValue(item.month) ?? 1;
            const uma2 = {
                outfitId: '',
                speed: 1200,
                stamina: 1200,
                power: 800,
                guts: 400,
                wisdom: 400,
                strategy: 'Senkou',
                distanceAptitude: 'S',
                surfaceAptitude: 'A',
                strategyAptitude: 'A',
                skills: [],
            };

            const payload = {
                courseId: item.course_set,
                nsamples: 1000,
                seed: 0,
                usePosKeep: false,
                useIntChecks: false,
                racedef: {
                    mood: stats.motivation ?? 3,
                    groundCondition: item.ground_condition ?? 1,
                    weather: item.weather ?? 1,
                    season: seasonValue,
                    time: item.time_zone ?? 2,
                    grade: item.grade ?? 100,
                    popularity: 1,
                    skillId: '',
                    orderRange: null,
                    numUmas: 9,
                },
                uma1,
                uma2,
            };

            const hash = await encodeUmalatorState(payload);
            const baseUrl = 'https://alpha123.github.io/uma-tools/umalator-global/';
            if (!hash) {
                window.open(baseUrl, '_blank');
                return;
            }
            window.open(`${baseUrl}#${hash}`, '_blank');
        }

        function showUmalatorError(message) {
            const modal = $('veteran-error-modal');
            const text = $('veteran-error-message');
            if (text) text.textContent = message || 'Select Uma 1 and Uma 2 first.';
            if (modal) modal.style.display = 'flex';
        }

        function buildVeteranUma(item, context = {}) {
            if (!item) return null;
            const stats = item.stats || {};
            const aptitudes = item.aptitudes || {};
            const runningStyle = item.running_style || 'Pace';
            const styleMap = {
                Front: { strategy: 'Nige', label: 'Front' },
                Pace: { strategy: 'Senkou', label: 'Pace' },
                Late: { strategy: 'Sasi', label: 'Late' },
                End: { strategy: 'Oikomi', label: 'End' },
            };
            const style = styleMap[runningStyle] || styleMap.Pace;
            const order = ['G', 'G+', 'F', 'F+', 'E', 'E+', 'D', 'D+', 'C', 'C+', 'B', 'B+', 'A', 'A+', 'S'];
            const maxApt = (values) => {
                if (!values) return 'A';
                let best = 'G';
                for (const value of Object.values(values)) {
                    if (order.indexOf(value) > order.indexOf(best)) best = value;
                }
                return best || 'A';
            };
            const distanceType = context.distanceType || null;
            const surfaceLabel = context.surfaceLabel || null;
            return {
                outfitId: item.card_id ? String(item.card_id) : '',
                speed: stats.speed ?? 0,
                stamina: stats.stamina ?? 0,
                power: stats.power ?? 0,
                guts: stats.guts ?? 0,
                wisdom: stats.wit ?? 0,
                strategy: style.strategy,
                distanceAptitude: distanceType ? (aptitudes.distance?.[distanceType] || 'A') : (maxApt(aptitudes.distance) || 'A'),
                surfaceAptitude: surfaceLabel ? (aptitudes.track?.[surfaceLabel] || 'A') : (maxApt(aptitudes.track) || 'A'),
                strategyAptitude: aptitudes.style?.[style.label] || 'A',
                skills: (item.skills || []).map(s => s.id ?? s.skill_id).filter(Boolean),
            };
        }

        function buildVeteranUmaFromData(data, context = {}) {
            if (!data) return null;
            const stats = data.stats || {};
            const aptitudes = data.aptitudes || {};
            const order = ['G', 'G+', 'F', 'F+', 'E', 'E+', 'D', 'D+', 'C', 'C+', 'B', 'B+', 'A', 'A+', 'S'];
            const maxApt = (values) => {
                if (!values) return 'A';
                let best = 'G';
                for (const value of Object.values(values)) {
                    if (order.indexOf(value) > order.indexOf(best)) best = value;
                }
                return best || 'A';
            };
            const distanceType = context.distanceType || null;
            const surfaceLabel = context.surfaceLabel || null;
            return {
                outfitId: data.chara?.id ? String(data.chara.id) : '',
                speed: stats.speed ?? 0,
                stamina: stats.stamina ?? 0,
                power: stats.power ?? 0,
                guts: stats.guts ?? 0,
                wisdom: stats.wit ?? 0,
                strategy: 'Senkou',
                distanceAptitude: distanceType ? (aptitudes.distance?.[distanceType] || 'A') : (maxApt(aptitudes.distance) || 'A'),
                surfaceAptitude: surfaceLabel ? (aptitudes.track?.[surfaceLabel] || 'A') : (maxApt(aptitudes.track) || 'A'),
                strategyAptitude: maxApt(aptitudes.style) || 'A',
                skills: (data.skills || []).map(s => s.id ?? s.skill_id).filter(Boolean),
            };
        }

        async function openVeteranUmalator() {
            if (!selectedVeteranUma1 && !cachedVeteranUma1Data) {
                showUmalatorError('Select Uma 1 first.');
                return;
            }
            if (!selectedVeteranUma2 && !cachedVeteranUma2Data) {
                showUmalatorError('Select Uma 2 first.');
                return;
            }
            const preset = selectedPreset;
            const courseId = preset?.courseId || null;
            let courseInfo = null;
            if (courseId) {
                try {
                    const res = await fetch(`/api/course-set/${courseId}`);
                    courseInfo = await res.json();
                } catch (e) {
                    courseInfo = null;
                }
            }
            const distanceMeters = courseInfo?.distance_m ?? preset?.distance_m ?? null;
            const distanceType = distanceTypeFromMeters(distanceMeters);
            const surfaceLabel = courseInfo?.ground
                ? surfaceLabelFromGround(courseInfo.ground)
                : (preset?.is_dirt === true ? 'Dirt' : preset?.is_dirt === false ? 'Turf' : null);
            const context = { distanceType, surfaceLabel };

            const uma1 = selectedVeteranUma1
                ? buildVeteranUma(selectedVeteranUma1, context)
                : buildVeteranUmaFromData(cachedVeteranUma1Data, context);
            const uma2 = selectedVeteranUma2
                ? buildVeteranUma(selectedVeteranUma2, context)
                : buildVeteranUmaFromData(cachedVeteranUma2Data, context);
            if (!uma1 || !uma2) {
                showUmalatorError('Missing veteran data for Uma 1 or Uma 2.');
                return;
            }
            const payload = courseId ? {
                courseId,
                nsamples: 1000,
                seed: 0,
                usePosKeep: false,
                useIntChecks: false,
                racedef: {
                    mood: 2,
                    ground: preset?.ground ?? 1,
                    weather: preset?.weather ?? 1,
                    season: preset?.season ?? 1,
                    time: preset?.time ?? 2,
                    grade: 100,
                },
                uma1,
                uma2,
            } : { uma1, uma2 };
            const hash = await encodeUmalatorState(payload);
            const baseUrl = 'https://alpha123.github.io/uma-tools/umalator-global/';
            if (!hash) {
                window.open(baseUrl, '_blank');
                return;
            }
            window.open(`${baseUrl}#${hash}`, '_blank');
        }

        function renderRaceRow(list, item) {
            const row = document.createElement('div');
            row.className = 'race-item';

            const label = document.createElement('div');
            label.className = 'race-label';
            const line1 = document.createElement('div');
            const line2 = document.createElement('div');
            if (item.turn) {
                line1.textContent = `Turn ${item.turn}`;
            } else {
                line1.textContent = item.kind === 'objective' ? 'Turn -' : (item.year ? `Year ${item.year}` : 'Race');
            }
            const classLabel = item.kind === 'objective'
                ? classFromTurn(item.turn)
                : classFromYear(item.year);
            const halfLabel = item.half === 1 ? 'Early' : item.half === 2 ? 'Late' : null;
            const monthNames = {
                1: 'January', 2: 'February', 3: 'March', 4: 'April',
                5: 'May', 6: 'June', 7: 'July', 8: 'August',
                9: 'September', 10: 'October', 11: 'November', 12: 'December',
            };
            const monthLabel = item.month ? monthNames[item.month] || `M${item.month}` : null;
            const timing = (halfLabel && monthLabel) ? `${halfLabel} ${monthLabel}` : (item.timing || null);
            if (classLabel || timing) {
                line2.textContent = `${classLabel || ''}${classLabel && timing ? ' ' : ''}${timing || ''}`.trim();
            }
            label.appendChild(line1);
            if (line2.textContent) {
                label.appendChild(line2);
            }
            const gradeIconMap = {
                "G1": "/assets/icons/utx_txt_grade_ribbon_05.png",
                "G2": "/assets/icons/utx_txt_grade_ribbon_04.png",
                "G3": "/assets/icons/utx_txt_grade_ribbon_03.png",
                "OP/Listed": "/assets/icons/utx_txt_grade_ribbon_02.png",
                "Pre-OP": "/assets/icons/utx_txt_grade_ribbon_06.png",
                "Maiden": "/assets/icons/utx_txt_grade_ribbon_01.png",
                "Debut": "/assets/icons/utx_txt_grade_ribbon_01.png",
                "Class": "/assets/icons/utx_txt_grade_ribbon_07.png",
            };
            if (item.grade_label || item.grade) {
                const labelText = item.grade_label ? item.grade_label : `Grade ${item.grade}`;
                label.appendChild(racePill(null, gradeIconMap[labelText], { className: 'race-pill-grade' }));
            }
            if (item.need_fans) {
                const fans = document.createElement('div');
                fans.textContent = `Fan Req: ${item.need_fans}`;
                label.appendChild(fans);
            }
            if (item.kind === 'objective') {
                const tag = document.createElement('div');
                tag.className = 'race-objective-tag';
                tag.textContent = 'Objective';
                label.appendChild(tag);
            }

            const info = document.createElement('div');
            info.className = 'race-info';

            if (item.banner_url) {
                const img = document.createElement('img');
                img.className = 'race-banner';
                img.src = item.banner_url;
                img.alt = item.name || `Program ${item.program_id}`;
                info.appendChild(img);
            }

            const id = document.createElement('div');
            id.className = 'race-id';

            const title = document.createElement('div');
            const program = document.createElement('span');
            program.textContent = `Program ${item.program_id}`;
            title.appendChild(program);
            if (item.name) {
                const name = document.createElement('span');
                name.textContent = ` - ${item.name}`;
                title.appendChild(name);
            }
            id.appendChild(title);

            if (item.kind === 'objective') {
                const requirement = document.createElement('div');
                requirement.className = 'race-requirement';
                requirement.textContent = item.requirement || 'Participate';
                id.appendChild(requirement);
            }

            const meta = document.createElement('div');
            meta.className = 'race-meta';
            if (item.ground_label || item.ground) {
                meta.appendChild(racePill(item.ground_label ? item.ground_label : (item.ground === 1 ? 'Turf' : 'Dirt')));
            }
            if (item.distance_type) {
                meta.appendChild(racePill(item.distance_type));
            }
            if (item.distance_m) {
                meta.appendChild(racePill(`${item.distance_m}m`));
            }
            if (item.track_name) {
                meta.appendChild(racePill(item.track_name));
            }
            if (item.direction) {
                const handed = item.direction === 'Clockwise'
                    ? 'Right-handed'
                    : item.direction === 'Counterclockwise'
                        ? 'Left-handed'
                        : item.direction;
                meta.appendChild(racePill(handed));
            }
            const season = item.season ? seasonFromValue(item.season) : seasonFromMonth(item.month);
            if (season) {
                meta.appendChild(racePill(season.label, season.icon));
            }
            const timeOfDay = item.time_zone !== null && item.time_zone !== undefined ? timeFromValue(item.time_zone) : null;
            if (timeOfDay) {
                meta.appendChild(racePill(timeOfDay.label, timeOfDay.icon));
            }
            const weather = item.weather !== null && item.weather !== undefined ? weatherFromValue(item.weather) : null;
            if (weather) {
                meta.appendChild(racePill(weather.label, weather.icon));
            }
            const condition = item.ground_condition !== null && item.ground_condition !== undefined
                ? groundConditionFromValue(item.ground_condition)
                : null;
            if (condition) {
                meta.appendChild(racePill(condition));
            }
            if (meta.childNodes.length) {
                id.appendChild(meta);
            }

            if (item.grade_label === 'G1') {
                const btn = document.createElement('button');
                btn.className = 'umalator-btn';
                btn.textContent = 'Open in Umalator';
                btn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    openUmalator(item);
                });
                id.appendChild(btn);
            }

            info.appendChild(id);
            row.appendChild(label);
            row.appendChild(info);
            list.appendChild(row);
        }

        function updateRaceTab(state) {
            const list = $('race-list');
            const combinedList = $('race-combined');
            if (!list || !combinedList) return;
            list.innerHTML = '';
            combinedList.innerHTML = '';

            const currentTurn = state.training?.current_turn || 0;
            const isPastTurn = (item) => {
                const turn = item?.turn || 0;
                if (!turn || !currentTurn) return false;
                return turn < currentTurn;
            };

            const agendaList = state.race_agenda || [];
            const agenda = agendaList.find(item => item.deck_num === 0) || agendaList[0];
            const races = (agenda?.race_array || []).filter(item => !isPastTurn(item));
            if (!races.length) {
                const empty = document.createElement('span');
                empty.className = 'skills-empty';
                empty.textContent = 'No race data available';
                list.appendChild(empty);
            } else {
                for (const race of races) {
                    renderRaceRow(list, { ...race, kind: 'agenda' });
                }
            }

            const objectives = $('objective-list');
            if (objectives) {
                objectives.innerHTML = '';
                const items = (state.race_objectives || []).filter(item => !isPastTurn(item));
                if (!items.length) {
                    const empty = document.createElement('span');
                    empty.className = 'skills-empty';
                    empty.textContent = 'No objectives available';
                    objectives.appendChild(empty);
                } else {
                    for (const obj of items) {
                        renderRaceRow(objectives, { ...obj, kind: 'objective' });
                    }
                }
            }

            let combinedItems = (state.race_combined || []).filter(item => !isPastTurn(item));
            if (combinedItems.length) {
                combinedItems = [...combinedItems].sort((a, b) => {
                    const aTurn = a.turn || 0;
                    const bTurn = b.turn || 0;
                    if (aTurn && bTurn) return aTurn - bTurn;
                    if (aTurn && !bTurn) return -1;
                    if (!aTurn && bTurn) return 1;
                    const yearDiff = (a.year || 0) - (b.year || 0);
                    if (yearDiff !== 0) return yearDiff;
                    const monthDiff = (a.month || 0) - (b.month || 0);
                    if (monthDiff !== 0) return monthDiff;
                    const halfDiff = (a.half || 0) - (b.half || 0);
                    if (halfDiff !== 0) return halfDiff;
                    return (a.program_id || 0) - (b.program_id || 0);
                });
            }
            if (!combinedItems.length) {
                const empty = document.createElement('span');
                empty.className = 'skills-empty';
                empty.textContent = 'No race data available';
                combinedList.appendChild(empty);
            } else {
                for (const item of combinedItems) {
                    renderRaceRow(combinedList, item);
                }
            }

            const objectiveCard = $('objective-card');
            const agendaCard = $('agenda-card');
            const toggleObj = $('toggle-objectives');
            const toggleAgenda = $('toggle-agenda');
            if (objectiveCard && toggleObj) {
                objectiveCard.style.display = toggleObj.checked ? '' : 'none';
            }
            if (agendaCard && toggleAgenda) {
                agendaCard.style.display = toggleAgenda.checked ? '' : 'none';
            }
            const eventBox = $('event-choices');
            if (!eventBox) return;
            eventBox.innerHTML = '';

            const choices = state.event_choices || [];
            if (!choices.length) {
                const empty = document.createElement('span');
                empty.className = 'skills-empty';
                empty.textContent = 'No event choices available';
                eventBox.appendChild(empty);
                return;
            }

            const effectMap = {
                1: 'Speed',
                2: 'Stamina',
                3: 'Power',
                4: 'Guts',
                5: 'Wit',
                10: 'Energy',
                20: 'Mood',
                30: 'Skill Pts',
            };

            for (const choice of choices) {
                const card = document.createElement('div');
                card.className = 'event-choice';

                const title = document.createElement('div');
                title.className = 'event-title';
                title.textContent = `Choice ${choice.select_index}`;
                card.appendChild(title);

                const effects = choice.gain_param_array || [];
                if (!effects.length) {
                    const eff = document.createElement('div');
                    eff.className = 'event-effect';
                    eff.textContent = 'No effects';
                    card.appendChild(eff);
                } else {
                    for (const effect of effects) {
                        const eff = document.createElement('div');
                        eff.className = 'event-effect';
                        const label = effectMap[effect.effect_value_0] || `Effect ${effect.effect_value_0}`;
                        const value = effect.effect_value_1 ?? 0;
                        eff.textContent = `${label} +${value}`;
                        card.appendChild(eff);
                    }
                }

                eventBox.appendChild(card);
            }
        }

        function updateMiscTab(state) {
            const grid = $('misc-grid');
            if (!grid) return;
            grid.innerHTML = '';

            const misc = state.misc_data || {};
            const sections = [
                ["User Info", misc.user_info || {}],
                ["TP Info", misc.tp_info || {}],
                ["RP Info", misc.rp_info || {}],
                ["Coin Info", misc.coin_info || {}],
                ["Common Define", misc.common_define || {}],
            ];

            const hasData = sections.some(([, data]) => data && Object.keys(data).length);
            if (!hasData) {
                const empty = document.createElement('span');
                empty.className = 'skills-empty';
                empty.textContent = 'No misc data available';
                grid.appendChild(empty);
                return;
            }

            for (const [title, data] of sections) {
                if (!data || !Object.keys(data).length) {
                    continue;
                }
                const section = document.createElement('div');
                section.className = 'misc-section';
                const heading = document.createElement('h3');
                heading.textContent = title;
                section.appendChild(heading);

                for (const [key, value] of Object.entries(data)) {
                    const row = document.createElement('div');
                    row.className = 'misc-item';
                    const label = document.createElement('div');
                    label.className = 'misc-key';
                    label.textContent = key;
                    const val = document.createElement('div');
                    val.className = 'misc-value';
                    val.textContent = value === null ? '-' : String(value);
                    row.appendChild(label);
                    row.appendChild(val);
                    section.appendChild(row);
                }
                grid.appendChild(section);
            }
        }

        function rankBadgeDataUri(label) {
            const colors = {
                "G": "#6b7280",
                "G+": "#64748b",
                "F": "#94a3b8",
                "F+": "#a8b2c0",
                "E": "#60a5fa",
                "E+": "#3b82f6",
                "D": "#34d399",
                "D+": "#10b981",
                "C": "#fbbf24",
                "C+": "#f59e0b",
                "B": "#f97316",
                "B+": "#ea580c",
                "A": "#ef4444",
                "A+": "#dc2626",
                "S": "#a855f7",
                "SS": "#7c3aed",
            };
            const text = String(label || "?");
            const bg = colors[text] || "#6b7280";
            const svg = `
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="22">
                    <rect x="1" y="1" width="46" height="20" rx="10" fill="${bg}" stroke="rgba(255,255,255,0.6)" stroke-width="1"/>
                    <text x="24" y="15" text-anchor="middle" font-size="11" fill="#fff" font-weight="700"
                        font-family="'Noto Sans JP', 'Segoe UI', sans-serif">${text}</text>
                </svg>`;
            return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
        }

        const HORSE_RANK_ORDER = ["G", "G+", "F", "F+", "E", "E+", "D", "D+", "C", "C+", "B", "B+", "A", "A+", "S", "S+", "SS"];
        const STATUS_RANK_ICON_INDEX = {
            'G': 0, 'G+': 1, 'F': 2, 'F+': 3, 'E': 4, 'E+': 5,
            'D': 6, 'D+': 7, 'C': 8, 'C+': 9, 'B': 10, 'B+': 11,
            'A': 12, 'A+': 13, 'S': 14, 'SS': 16, 'SS+': 17,
        };
        function horseRankIcon(label) {
            const idx = HORSE_RANK_ORDER.indexOf(label);
            if (idx < 0) return null;
            return `/assets/icons/umarank/utx_txt_rank_${String(idx).padStart(2, '0')}.png`;
        }
        function statusRankIcon(label) {
            const idx = STATUS_RANK_ICON_INDEX[label];
            if (idx === undefined) return null;
            return `/assets/icons/statusrank/ui_statusrank_${String(idx).padStart(2, '0')}.png`;
        }
        function veteranStatRankLabel(value) {
            const val = Number(value || 0);
            if (val >= 1150) return 'SS+';
            if (val >= 1100) return 'SS';
            if (val >= 1000) return 'S';
            if (val >= 800) return 'A';
            if (val >= 600) return 'B';
            if (val >= 400) return 'C';
            if (val >= 300) return 'D';
            if (val >= 200) return 'E';
            if (val >= 100) return 'F';
            return 'G';
        }

        let veteranCache = [];
        let favoriteIds = new Set();
        let selectedVeteranUma1 = null;
        let selectedVeteranUma2 = null;
        let cachedVeteranUma1Data = null;
        let cachedVeteranUma2Data = null;
        let umalatorPresets = [];
        let selectedPreset = null;
        const VETERAN_FILTERS_KEY = 'bifrost-veteran-filters';

        function updateUmalatorSlots() {
            const slot1 = $('umalator-slot-1');
            const slot2 = $('umalator-slot-2');
            if (slot1) {
                const name = selectedVeteranUma1?.name || cachedVeteranUma1Data?.chara?.name;
                slot1.textContent = name || 'No selection';
            }
            if (slot2) {
                const name = selectedVeteranUma2?.name || cachedVeteranUma2Data?.chara?.name;
                slot2.textContent = name || 'No selection';
            }
        }

        function buildVeteranSelectionData(item) {
            if (!item) return null;
            const stats = item.stats || {};
            const aptitudes = item.aptitudes || {};
            return {
                chara: {
                    id: item.chara_id ?? item.single_mode_chara_id ?? item.card_id ?? 0,
                    name: item.name || 'Unknown',
                    portrait_url: item.portrait_url || '',
                    portrait_fallback_url: item.portrait_fallback_url || '',
                },
                stats: {
                    speed: stats.speed ?? 0,
                    stamina: stats.stamina ?? 0,
                    power: stats.power ?? 0,
                    guts: stats.guts ?? 0,
                    wit: stats.wit ?? 0,
                    skill_pts: item.skill_pts ?? 0,
                    energy: item.energy ?? 0,
                    motivation: item.motivation ?? 0,
                },
                aptitudes: {
                    track: aptitudes.track || {},
                    distance: aptitudes.distance || {},
                    style: aptitudes.style || {},
                },
                skills: (item.skills || []).map((skill) => ({
                    id: skill.id ?? skill.skill_id,
                    name: skill.name,
                    level: skill.level ?? 1,
                })).filter(skill => skill.id),
            };
        }

        async function saveSelectedVeterans() {
            const toKey = (item) => {
                if (!item) return null;
                return item.trained_chara_id ?? item.card_id ?? null;
            };
            const payload = {
                uma1_id: toKey(selectedVeteranUma1),
                uma2_id: toKey(selectedVeteranUma2),
                uma1_data: buildVeteranSelectionData(selectedVeteranUma1),
                uma2_data: buildVeteranSelectionData(selectedVeteranUma2),
            };
            try {
                await fetch('/api/veteran-selection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
            } catch (e) {
                // ignore cache write errors
            }
        }

        async function restoreSelectedVeterans() {
            const matchByKey = (items, key) => {
                if (!key) return null;
                return items.find(item => (item.trained_chara_id ?? item.card_id) === key) || null;
            };
            try {
                const res = await fetch('/api/veteran-selection');
                const data = await res.json();
                const key1 = data.uma1_id ?? data.uma1;
                const key2 = data.uma2_id ?? data.uma2;
                selectedVeteranUma1 = matchByKey(veteranCache, key1);
                selectedVeteranUma2 = matchByKey(veteranCache, key2);
                cachedVeteranUma1Data = data.uma1_data || null;
                cachedVeteranUma2Data = data.uma2_data || null;
            } catch (e) {
                selectedVeteranUma1 = null;
                selectedVeteranUma2 = null;
                cachedVeteranUma1Data = null;
                cachedVeteranUma2Data = null;
            }
            updateUmalatorSlots();
        }

        function loadFavorites() {
            try {
                const raw = localStorage.getItem('bifrost-veteran-favorites');
                const ids = raw ? JSON.parse(raw) : [];
                favoriteIds = new Set(Array.isArray(ids) ? ids : []);
            } catch (e) {
                favoriteIds = new Set();
            }
        }

        function saveFavorites() {
            localStorage.setItem('bifrost-veteran-favorites', JSON.stringify([...favoriteIds]));
        }

        function initVeteranFilters() {
            const filterOptions = ['Any', 'G', 'G+', 'F', 'F+', 'E', 'E+', 'D', 'D+', 'C', 'C+', 'B', 'B+', 'A', 'A+', 'S'];
            const filterIds = [
                'veteran-filter-turf',
                'veteran-filter-dirt',
                'veteran-filter-sprint',
                'veteran-filter-mile',
                'veteran-filter-medium',
                'veteran-filter-long',
                'veteran-filter-front',
                'veteran-filter-pace',
                'veteran-filter-late',
                'veteran-filter-end',
            ];
            for (const id of filterIds) {
                const el = $(id);
                if (!el || el.dataset.ready) continue;
                el.innerHTML = '';
                for (const opt of filterOptions) {
                    const option = document.createElement('option');
                    option.value = opt;
                    option.textContent = opt;
                    el.appendChild(option);
                }
                el.dataset.ready = '1';
            }
        }

        function saveVeteranFilters() {
            const payload = {
                sort: $('veteran-sort')?.value || 'rank_score',
                order: $('veteran-sort-order')?.value || 'desc',
                locked: $('veteran-filter-locked')?.checked || false,
                favorite: $('veteran-filter-favorite')?.checked || false,
                search: $('veteran-search')?.value || '',
                filters: {
                    turf: $('veteran-filter-turf')?.value || 'Any',
                    dirt: $('veteran-filter-dirt')?.value || 'Any',
                    sprint: $('veteran-filter-sprint')?.value || 'Any',
                    mile: $('veteran-filter-mile')?.value || 'Any',
                    medium: $('veteran-filter-medium')?.value || 'Any',
                    long: $('veteran-filter-long')?.value || 'Any',
                    front: $('veteran-filter-front')?.value || 'Any',
                    pace: $('veteran-filter-pace')?.value || 'Any',
                    late: $('veteran-filter-late')?.value || 'Any',
                    end: $('veteran-filter-end')?.value || 'Any',
                },
                preset: $('veteran-preset-select')?.value || '',
            };
            localStorage.setItem(VETERAN_FILTERS_KEY, JSON.stringify(payload));
        }

        function restoreVeteranFilters() {
            try {
                const raw = localStorage.getItem(VETERAN_FILTERS_KEY);
                if (!raw) return;
                const data = JSON.parse(raw);
                if ($('veteran-sort')) $('veteran-sort').value = data.sort || 'rank_score';
                if ($('veteran-sort-order')) $('veteran-sort-order').value = data.order || 'desc';
                if ($('veteran-filter-locked')) $('veteran-filter-locked').checked = !!data.locked;
                if ($('veteran-filter-favorite')) $('veteran-filter-favorite').checked = !!data.favorite;
                if ($('veteran-search')) $('veteran-search').value = data.search || '';
                const filters = data.filters || {};
                const applyValue = (id, value) => {
                    const el = $(id);
                    if (el && value) el.value = value;
                };
                applyValue('veteran-filter-turf', filters.turf);
                applyValue('veteran-filter-dirt', filters.dirt);
                applyValue('veteran-filter-sprint', filters.sprint);
                applyValue('veteran-filter-mile', filters.mile);
                applyValue('veteran-filter-medium', filters.medium);
                applyValue('veteran-filter-long', filters.long);
                applyValue('veteran-filter-front', filters.front);
                applyValue('veteran-filter-pace', filters.pace);
                applyValue('veteran-filter-late', filters.late);
                applyValue('veteran-filter-end', filters.end);
                if (data.preset && $('veteran-preset-select')) {
                    $('veteran-preset-select').value = data.preset;
                }
                const presetValue = $('veteran-preset-select')?.value;
                if (presetValue && umalatorPresets.length) {
                    selectedPreset = umalatorPresets.find(p => String(p.courseId) === String(presetValue)) || umalatorPresets[0];
                }
            } catch (e) {
                // ignore cache restore errors
            }
        }

        async function loadUmalatorPresets() {
            const select = $('veteran-preset-select');
            if (!select) return;
            try {
                const res = await fetch('/api/umalator-presets');
                const data = await res.json();
                umalatorPresets = data.presets || [];
            } catch (e) {
                umalatorPresets = [];
            }

            select.innerHTML = '';
            if (!umalatorPresets.length) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'No presets available';
                select.appendChild(option);
                selectedPreset = null;
                return;
            }

            for (const preset of umalatorPresets) {
                const option = document.createElement('option');
                option.value = String(preset.courseId || '');
                const meters = preset.distance_m ? `${preset.distance_m}m` : 'Unknown';
                const surface = preset.is_dirt === true ? 'Dirt' : 'Turf';
                option.textContent = `${preset.name || `Preset ${preset.courseId}`} (${surface} ${meters})`;
                select.appendChild(option);
            }

            const saved = (() => {
                try {
                    return JSON.parse(localStorage.getItem(VETERAN_FILTERS_KEY) || '{}');
                } catch (e) {
                    return {};
                }
            })();
            const savedPreset = saved.preset ? String(saved.preset) : '';
            if (savedPreset && umalatorPresets.find(p => String(p.courseId) === savedPreset)) {
                select.value = savedPreset;
            }
            if (select.value) {
                selectedPreset = umalatorPresets.find(p => String(p.courseId) === select.value) || umalatorPresets[0];
            } else {
                selectedPreset = umalatorPresets[0];
                select.value = String(selectedPreset.courseId || '');
            }
        }

        async function loadVeteran() {
            try {
                const res = await fetch('/api/veteran');
                const data = await res.json();
                veteranCache = data.items || [];
                loadFavorites();
                initVeteranFilters();
                await loadUmalatorPresets();
                restoreVeteranFilters();
                await restoreSelectedVeterans();
                renderVeteran();
            } catch (e) {
                const list = $('veteran-list');
                if (list) {
                    list.innerHTML = '<span class="skills-empty">Failed to load veteran data</span>';
                }
            }
        }

        function renderVeteran() {
            const list = $('veteran-list');
            if (!list) return;
            list.innerHTML = '';

            const sortKey = $('veteran-sort')?.value || 'rank_score';
            const sortOrder = $('veteran-sort-order')?.value || 'desc';
            const lockedOnly = $('veteran-filter-locked')?.checked || false;
            const favoriteOnly = $('veteran-filter-favorite')?.checked || false;
            const searchTerm = ($('veteran-search')?.value || '').trim();
            const items = [...veteranCache];
            const applyLocked = lockedOnly;
            const applyFavorite = favoriteOnly;
            let titleQuery = null;
            let nameQuery = searchTerm;
            const titleMatch = searchTerm.match(/\[([^\]]+)\]/);
            if (titleMatch) {
                titleQuery = titleMatch[1].trim().toLowerCase();
                nameQuery = searchTerm.replace(titleMatch[0], "").trim();
            }

            const filterValue = (id) => ($(`${id}`)?.value || 'Any');
            const order = ['G', 'G+', 'F', 'F+', 'E', 'E+', 'D', 'D+', 'C', 'C+', 'B', 'B+', 'A', 'A+', 'S'];
            const rankIndex = (label) => {
                const idx = order.indexOf(label);
                return idx < 0 ? -1 : idx;
            };
            const atLeast = (value, min) => {
                if (!min || min === 'Any') return true;
                return rankIndex(value) >= rankIndex(min);
            };
            const filtered = items.filter((item) => {
                const apt = item.aptitudes || {};
                if (applyLocked && !item.is_locked) {
                    return false;
                }
                const favoriteId = item.trained_chara_id ?? item.card_id;
                if (applyFavorite && !favoriteIds.has(favoriteId)) {
                    return false;
                }
                if (searchTerm) {
                    if (titleQuery) {
                        const title = (item.title || '').toLowerCase();
                        if (!title.startsWith(titleQuery)) {
                            return false;
                        }
                    }
                    if (nameQuery) {
                        const name = (item.name || '').toLowerCase();
                        if (!name.includes(nameQuery.toLowerCase())) {
                            return false;
                        }
                    }
                }
                return (
                    atLeast(apt.track?.Turf, filterValue('veteran-filter-turf')) &&
                    atLeast(apt.track?.Dirt, filterValue('veteran-filter-dirt')) &&
                    atLeast(apt.distance?.Sprint, filterValue('veteran-filter-sprint')) &&
                    atLeast(apt.distance?.Mile, filterValue('veteran-filter-mile')) &&
                    atLeast(apt.distance?.Medium, filterValue('veteran-filter-medium')) &&
                    atLeast(apt.distance?.Long, filterValue('veteran-filter-long')) &&
                    atLeast(apt.style?.Front, filterValue('veteran-filter-front')) &&
                    atLeast(apt.style?.Pace, filterValue('veteran-filter-pace')) &&
                    atLeast(apt.style?.Late, filterValue('veteran-filter-late')) &&
                    atLeast(apt.style?.End, filterValue('veteran-filter-end'))
                );
            });

            const sortValue = (item) => {
                if (sortKey === 'skill_count') return item.skills?.length || 0;
                return item[sortKey] || item.stats?.[sortKey] || 0;
            };
            filtered.sort((a, b) => {
                const diff = sortValue(b) - sortValue(a);
                return sortOrder === 'asc' ? -diff : diff;
            });

            const summary = [];
            if (lockedOnly) summary.push('Locked only');
            if (favoriteOnly) summary.push('Favorites only');
            if (searchTerm) summary.push(`Search "${searchTerm}"`);
            const filterPairs = [
                ['Turf', filterValue('veteran-filter-turf')],
                ['Dirt', filterValue('veteran-filter-dirt')],
                ['Sprint', filterValue('veteran-filter-sprint')],
                ['Mile', filterValue('veteran-filter-mile')],
                ['Medium', filterValue('veteran-filter-medium')],
                ['Long', filterValue('veteran-filter-long')],
                ['Front', filterValue('veteran-filter-front')],
                ['Pace', filterValue('veteran-filter-pace')],
                ['Late', filterValue('veteran-filter-late')],
                ['End', filterValue('veteran-filter-end')],
            ];
            for (const [label, value] of filterPairs) {
                if (value && value !== 'Any') summary.push(`${label} ${value}+`);
            }
            const summaryEl = $('veteran-filters-summary');
            if (summaryEl) {
                summaryEl.textContent = summary.length ? summary.join(' | ') : 'No filters';
            }

            if (!filtered.length) {
                list.innerHTML = '<span class="skills-empty">No veteran data available</span>';
                return;
            }

            const selectedKey1 = selectedVeteranUma1
                ? (selectedVeteranUma1.trained_chara_id ?? selectedVeteranUma1.card_id)
                : null;
            const selectedKey2 = selectedVeteranUma2
                ? (selectedVeteranUma2.trained_chara_id ?? selectedVeteranUma2.card_id)
                : null;

            for (const item of filtered) {
                const card = document.createElement('div');
                card.className = 'veteran-card';
                card.style.cursor = 'pointer';
                card.onclick = () => showVeteranDetail(item);

                const favoriteId = item.trained_chara_id ?? item.card_id;
                const isFavorite = favoriteIds.has(favoriteId);
                if (favoriteId && favoriteId === selectedKey1) {
                    card.classList.add('selected-uma', 'selected-uma-1');
                    const tag = document.createElement('span');
                    tag.className = 'veteran-compare-tag';
                    tag.textContent = 'Uma 1';
                    card.appendChild(tag);
                } else if (favoriteId && favoriteId === selectedKey2) {
                    card.classList.add('selected-uma', 'selected-uma-2');
                    const tag = document.createElement('span');
                    tag.className = 'veteran-compare-tag uma2';
                    tag.textContent = 'Uma 2';
                    card.appendChild(tag);
                }
                const favBtn = document.createElement('button');
                favBtn.className = 'favorite-star';
                favBtn.textContent = isFavorite ? '' : '';
                favBtn.title = isFavorite ? 'Unfavorite' : 'Favorite';
                favBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    if (favoriteIds.has(favoriteId)) {
                        favoriteIds.delete(favoriteId);
                    } else {
                        favoriteIds.add(favoriteId);
                    }
                    saveFavorites();
                    renderVeteran();
                });
                card.appendChild(favBtn);

                const img = document.createElement('img');
                img.className = 'veteran-portrait';
                img.src = item.portrait_url || 'https://umapyoi.net/missing_chara.png';
                img.alt = item.name || 'Veteran';
                img.onerror = () => {
                    img.onerror = null;
                    img.src = item.portrait_fallback_url || 'https://umapyoi.net/missing_chara.png';
                };

                const body = document.createElement('div');
                const name = document.createElement('div');
                name.className = 'veteran-name';
                name.textContent = item.name || 'Unknown';

                const meta = document.createElement('div');
                meta.className = 'veteran-meta';
                const rankLabel = item.rank_label || item.rank || '-';
                const rankIcon = horseRankIcon(rankLabel);
                const lockText = item.is_locked ? 'Locked' : 'Unlocked';
                meta.innerHTML = `${rankIcon ? `<img class="umarank-icon" src="${rankIcon}" alt="${rankLabel}">` : ''}` +
                    `${rankLabel} | Score ${item.rank_score || 0} | Skills ${(item.skills || []).length} | ${item.running_style || '-'} | ${lockText}`;

                const stats = document.createElement('div');
                stats.className = 'veteran-stats';
                const s = item.stats || {};
                stats.innerHTML = `
                    <div><span class="veteran-stat-label">SPD</span><span class="veteran-stat-value">${s.speed || 0}</span></div>
                    <div><span class="veteran-stat-label">STA</span><span class="veteran-stat-value">${s.stamina || 0}</span></div>
                    <div><span class="veteran-stat-label">POW</span><span class="veteran-stat-value">${s.power || 0}</span></div>
                    <div><span class="veteran-stat-label">GUT</span><span class="veteran-stat-value">${s.guts || 0}</span></div>
                    <div><span class="veteran-stat-label">WIT</span><span class="veteran-stat-value">${s.wit || 0}</span></div>
                `;

                body.appendChild(name);
                body.appendChild(meta);
                body.appendChild(stats);
                card.appendChild(img);
                card.appendChild(body);
                list.appendChild(card);
            }
        }

        function renderVeteranDetail(item) {
            const empty = $('veteran-detail-empty');
            const detail = $('veteran-detail');
            const detailCard = $('veteran-detail-card');
            if (!detail || !empty) return;

            if (detailCard) detailCard.style.display = '';
            empty.style.display = 'none';
            detail.style.display = '';

            const rankLabel = item.rank_label || item.rank || '-';
            const rankIcon = horseRankIcon(rankLabel);
            const portrait = $('veteran-portrait');
            portrait.src = item.portrait_url || 'https://umapyoi.net/missing_chara.png';
            portrait.onerror = () => {
                portrait.onerror = null;
                portrait.src = item.portrait_fallback_url || 'https://umapyoi.net/missing_chara.png';
            };
            $('veteran-name').textContent = item.name || 'Unknown';
            $('veteran-rank').innerHTML = `${rankIcon ? `<img class="umarank-icon" src="${rankIcon}" alt="${rankLabel}">` : ''} ${rankLabel} | Score ${item.rank_score || 0}`;
            $('veteran-style').textContent = `Running Style: ${item.running_style || '-'} | Fans ${(item.fans || 0).toLocaleString()}`;
            $('veteran-uma1').onclick = () => {
                selectedVeteranUma1 = item;
                updateUmalatorSlots();
                saveSelectedVeterans();
                renderVeteran();
                if (window.__closeVeteranDetail) window.__closeVeteranDetail();
            };
            $('veteran-uma2').onclick = () => {
                selectedVeteranUma2 = item;
                updateUmalatorSlots();
                saveSelectedVeterans();
                renderVeteran();
                if (window.__closeVeteranDetail) window.__closeVeteranDetail();
            };

            const s = item.stats || {};
            $('vstat-speed').textContent = s.speed ?? 0;
            $('vstat-stamina').textContent = s.stamina ?? 0;
            $('vstat-power').textContent = s.power ?? 0;
            $('vstat-guts').textContent = s.guts ?? 0;
            $('vstat-wit').textContent = s.wit ?? 0;
            $('vmax-speed').textContent = '/1200';
            $('vmax-stamina').textContent = '/1200';
            $('vmax-power').textContent = '/1200';
            $('vmax-guts').textContent = '/1200';
            $('vmax-wit').textContent = '/1200';

            const statIconMap = {
                speed: '/assets/icons/status_00.png',
                stamina: '/assets/icons/status_01.png',
                power: '/assets/icons/status_02.png',
                guts: '/assets/icons/status_03.png',
                wit: '/assets/icons/status_04.png',
            };
            $('vstat-icon-speed').src = statIconMap.speed;
            $('vstat-icon-stamina').src = statIconMap.stamina;
            $('vstat-icon-power').src = statIconMap.power;
            $('vstat-icon-guts').src = statIconMap.guts;
            $('vstat-icon-wit').src = statIconMap.wit;

            const statRankIcon = (value) => {
                const label = veteranStatRankLabel(value);
                return statusRankIcon(label);
            };
            $('vrank-speed').src = statRankIcon(s.speed) || '';
            $('vrank-stamina').src = statRankIcon(s.stamina) || '';
            $('vrank-power').src = statRankIcon(s.power) || '';
            $('vrank-guts').src = statRankIcon(s.guts) || '';
            $('vrank-wit').src = statRankIcon(s.wit) || '';

            const apt = item.aptitudes || {};
            const aptIconIndex = {
                'G': 0, 'G+': 1, 'F': 2, 'F+': 3, 'E': 4, 'E+': 5,
                'D': 6, 'D+': 7, 'C': 8, 'C+': 9, 'B': 10, 'B+': 11,
                'A': 12, 'A+': 13, 'S': 14,
            };
            const aptIcon = (letter) => {
                const idx = aptIconIndex[letter] ?? 0;
                return `/assets/icons/statusrank/ui_statusrank_${String(idx).padStart(2, '0')}.png`;
            };
            const setApt = (id, letter, label) => {
                const el = $(id);
                if (!el) return;
                const value = letter || '-';
                el.innerHTML = `<span>${label}</span><img class="apt-icon" src="${aptIcon(value)}" alt="${value}">`;
            };
            setApt('vapt-turf', apt.track?.Turf, 'Turf');
            setApt('vapt-dirt', apt.track?.Dirt, 'Dirt');
            setApt('vapt-sprint', apt.distance?.Sprint, 'Sprint');
            setApt('vapt-mile', apt.distance?.Mile, 'Mile');
            setApt('vapt-medium', apt.distance?.Medium, 'Medium');
            setApt('vapt-long', apt.distance?.Long, 'Long');
            setApt('vapt-front', apt.style?.Front, 'Front');
            setApt('vapt-pace', apt.style?.Pace, 'Pace');
            setApt('vapt-late', apt.style?.Late, 'Late');
            setApt('vapt-end', apt.style?.End, 'End');

            const skills = $('veteran-skills');
            skills.innerHTML = '';
            if (item.skills && item.skills.length) {
                for (const skill of item.skills) {
                    const srow = document.createElement('div');
                    srow.className = 'skill-item';
                    let iconUrl = skill.icon_url || skill.icon || '';
                    if (!iconUrl && skill.id) {
                        const skillId = String(skill.id).padStart(6, '0');
                        iconUrl = `https://gametora.com/images/umamusume/skill_icons/utx_ico_skill_${skillId}.png`;
                    }
                    if (iconUrl) {
                        const icon = document.createElement('img');
                        icon.className = 'skill-icon';
                        icon.src = iconUrl;
                        icon.alt = skill.name || 'Skill';
                        icon.onerror = () => {
                            icon.onerror = null;
                            icon.remove();
                        };
                        srow.appendChild(icon);
                    }
                    const text = document.createElement('div');
                    text.className = 'skill-text';
                    text.textContent = `${skill.name} Lv ${skill.level}`;
                    srow.appendChild(text);
                    skills.appendChild(srow);
                }
            } else {
                const emptySkill = document.createElement('span');
                emptySkill.className = 'skills-empty';
                emptySkill.textContent = 'No skills data available';
                skills.appendChild(emptySkill);
            }
        }

        function resetVeteranDetail() {
            const empty = $('veteran-detail-empty');
            const detail = $('veteran-detail');
            const detailCard = $('veteran-detail-card');
            if (!detail || !empty) return;
            detail.style.display = 'none';
            empty.style.display = '';
            if (detailCard) detailCard.style.display = 'none';
        }

        function showVeteranDetail(item) {
            renderVeteranDetail(item);
            const detailCard = $('veteran-detail-card');
            if (!detailCard) return;

            const modal = document.createElement('div');
            modal.className = 'veteran-modal';
            const content = document.createElement('div');
            content.className = 'veteran-modal-content';
            modal.appendChild(content);

            const placeholder = document.createElement('div');
            detailCard.parentNode.insertBefore(placeholder, detailCard);
            content.appendChild(detailCard);

            const closeBtn = document.createElement('button');
            closeBtn.className = 'veteran-modal-close';
            closeBtn.textContent = 'Close';

            const closeModal = () => {
                if (placeholder.parentNode) {
                    placeholder.parentNode.insertBefore(detailCard, placeholder);
                    placeholder.remove();
                }
                resetVeteranDetail();
                modal.remove();
            };

            closeBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (event) => {
                if (event.target === modal) closeModal();
            });

            content.appendChild(closeBtn);
            document.body.appendChild(modal);
            window.__closeVeteranDetail = closeModal;
        }

        function connect() {
            if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
                return;
            }
            const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${proto}//${location.host}/ws`);

            ws.onopen = () => {
                $('status-text').textContent = 'Connected';
                $('status-dot').classList.add('connected');
                const connection = $('session-connection');
                if (connection) {
                    connection.textContent = 'Connected';
                    connection.classList.remove('training', 'disconnected');
                    connection.classList.add('connected');
                }
                if (reconnectTimer) {
                    clearTimeout(reconnectTimer);
                    reconnectTimer = null;
                }
            };

            ws.onclose = () => {
                $('status-text').textContent = 'Disconnected';
                $('status-dot').classList.remove('connected', 'training');
                const connection = $('session-connection');
                if (connection) {
                    connection.textContent = 'Disconnected';
                    connection.classList.remove('connected', 'training');
                    connection.classList.add('disconnected');
                }
                if (!reconnectTimer) {
                    reconnectTimer = setTimeout(() => {
                        reconnectTimer = null;
                        connect();
                    }, 3000);
                }
            };

            ws.onerror = () => {
                try {
                    ws.close();
                } catch (e) {
                    // ignore
                }
            };

            ws.onmessage = (e) => {
                const msg = JSON.parse(e.data);
                if (msg.type === 'state') {
                    updateUI(msg.data);
                } else if (msg.type === 'ping') {
                    ws.send('ping');
                }
            };
        }

        function getTurnDateInfo(turn) {
            if (!turn) return null;
            const exceptionMap = {
                1: { month: "April", half: "Early" },
                2: { month: "April", half: "Early" },
                3: { month: "May", half: "Early" },
                4: { month: "May", half: "Early" },
                5: { month: "June", half: "Early" },
                6: { month: "June", half: "Early" },
                7: { month: "April", half: "Late" },
                8: { month: "April", half: "Late" },
                9: { month: "May", half: "Late" },
                10: { month: "May", half: "Late" },
                11: { month: "June", half: "Late" },
                12: { month: "June", half: "Late" },
            };
            const yearLabel = turn <= 24 ? "Junior Year"
                : turn <= 48 ? "Classic Year"
                : turn <= 72 ? "Senior Year"
                : "URA Finals";
            const phase = turn <= 24 ? "Junior"
                : turn <= 48 ? "Classic"
                : turn <= 72 ? "Senior"
                : "URA";

            if (exceptionMap[turn]) {
                const entry = exceptionMap[turn];
                return { yearLabel, phase, month: entry.month, half: entry.half };
            }

            const months = [
                "July", "August", "September", "October", "November", "December",
                "January", "February", "March", "April", "May", "June"
            ];
            const offset = turn - 13;
            const monthIndex = Math.floor(offset / 2) % months.length;
            const half = (offset % 2 === 0) ? "Early" : "Late";
            return { yearLabel, phase, month: months[monthIndex], half };
        }

        function getNextRaceInfo(state) {
            const currentTurn = state?.training?.current_turn || 0;
            const races = state?.race_combined || [];
            let next = null;
            for (const item of races) {
                if (!item?.turn) continue;
                if (item.turn < currentTurn) continue;
                if (!next || item.turn < next.turn) next = item;
            }
            return next;
        }

        function updateUI(state) {
            lastState = state;
            if (state.in_training) {
                $('status-dot').classList.add('training');
                $('status-text').textContent = 'In Training';
            } else {
                $('status-dot').classList.remove('training');
                $('status-text').textContent = 'Connected';
            }

            const s = state.training.stats;
            const t = state.training;

            // Session bar
            $('session-turn').textContent = `${t.current_turn}/${t.max_turns}`;
            const raw = state.raw_data?.data || state.raw_data;
            const maxVital = raw?.chara_info?.max_vital || 100;
            $('session-energy').textContent = `${s.energy}/${maxVital}`;
            $('session-skillpts').textContent = s.skill_pts.toLocaleString();
            $('session-fans').textContent = t.fans.toLocaleString();
            const dateInfo = getTurnDateInfo(t.current_turn);
            const dateEl = $('session-date');
            if (dateEl && dateInfo) {
                dateEl.textContent = `${dateInfo.yearLabel} ${dateInfo.half} ${dateInfo.month}`;
            } else if (dateEl) {
                dateEl.textContent = '-';
            }
            const scenarioId = raw?.chara_info?.scenario_id;
            const scenarioName = t.scenario || SCENARIO_NAMES[scenarioId] || '-';
            const scenarioEl = $('session-scenario');
            if (scenarioEl) scenarioEl.textContent = scenarioName;
            const energyFill = $('session-energy-bar');
            if (energyFill) {
                const pct = Math.max(0, Math.min(100, (s.energy / maxVital) * 100));
                energyFill.style.width = `${pct}%`;
                energyFill.style.background = pct < 30 ? 'var(--danger)' : pct < 60 ? 'var(--warning)' : 'var(--success)';
            }

            // Motivation bubble
            const mot = MOTIVATION[s.motivation] || MOTIVATION[3];
            const motEl = $('session-motivation');
            motEl.textContent = mot.name;
            motEl.className = 'motivation-bubble ' + mot.class;
            const nextRace = getNextRaceInfo(state);
            const nextRaceEl = $('session-next-race');
            const nextIcon = $('session-next-icon');
            if (nextRaceEl) {
                if (nextRace && nextRace.turn) {
                    const diff = Math.max(0, nextRace.turn - t.current_turn);
                    nextRaceEl.textContent = diff === 0 ? 'Next race: Now' : `Next race in ${diff} turns`;
                } else {
                    nextRaceEl.textContent = 'Next race -';
                }
            }
            if (nextIcon) {
                if (nextRace?.banner_url) {
                    nextIcon.src = nextRace.banner_url;
                    nextIcon.style.display = '';
                } else {
                    nextIcon.removeAttribute('src');
                    nextIcon.style.display = 'none';
                }
            }
            const connection = $('session-connection');
            if (connection) {
                connection.style.display = 'none';
            }

            // Stats
            $('stat-speed').textContent = s.speed;
            $('stat-stamina').textContent = s.stamina;
            $('stat-power').textContent = s.power;
            $('stat-guts').textContent = s.guts;
            $('stat-wisdom').textContent = s.wisdom;

            // Update stat rank icons
            updateStatRankIcons(s);

            // Update training cards with command data
            trainingScores = {};
            ['speed', 'stamina', 'power', 'guts', 'wit'].forEach(stat => {
                updateTrainingCard(stat, state);
            });
            applySuggestedTraining(state);

            updateSupporters(state);
            updateSkillsTab(state);
            updateRaceTab(state);
            updateMiscTab(state);

            // Debug info
            $('info-packet').textContent = state.last_packet_type || '-';
            $('info-update').textContent = t.last_update ?
                new Date(t.last_update).toLocaleTimeString() : '-';

            // Store raw data
            if (state.raw_data) {
                lastRawData = state.raw_data;
            }
        }

        connect();
    </script>
</body>
</html>
